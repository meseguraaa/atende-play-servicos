name: Production Deploy

on:
  push:
    branches: ["main"]

concurrency:
  group: "production"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
           run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prisma generate (Linux)
        run: pnpm prisma generate
        env:
          DATABASE_URL: "postgresql://user:pass@127.0.0.1:5432/db?schema=public"

      - name: Build (Next.js)
        run: pnpm build
        env:
          DATABASE_URL: "postgresql://user:pass@127.0.0.1:5432/db?schema=public"

      - name: Package release artifact
        run: |
          set -euo pipefail
          rm -rf .release
          mkdir -p .release

          test -f .next/standalone/server.js
          cp -R .next/standalone/* .release/

          mkdir -p .release/.next
          cp -R .next/static .release/.next/static

          if [ -d "public" ]; then
            cp -R public .release/public
          fi

          echo "${GITHUB_SHA}" > .release/RELEASE_SHA
          tar -czf release.tgz -C .release .

      - name: Write SSH key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${{ secrets.PROD_SSH_PORT }}" -H "${{ secrets.PROD_SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Upload release to server
        run: |
          set -euo pipefail
          scp -P "${{ secrets.PROD_SSH_PORT }}" release.tgz "${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }}:/tmp/atendeplay-release.tgz"

      - name: Deploy on server (atomic symlink switch)
        run: |
          set -euo pipefail
          ssh -p "${{ secrets.PROD_SSH_PORT }}" "${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_SSH_HOST }}" << 'EOF'
          set -euo pipefail

          APP_NAME="atendeplay"
          BASE_DIR="/home/deploy/apps/${APP_NAME}"
          RELEASES_DIR="${BASE_DIR}/releases"
          SHARED_DIR="${BASE_DIR}/shared"
          CURRENT_LINK="${BASE_DIR}/current"

          mkdir -p "${RELEASES_DIR}"

          TS="$(date +%Y%m%d%H%M%S)"
          NEW_RELEASE="${RELEASES_DIR}/${TS}"

          mkdir -p "${NEW_RELEASE}"
          tar -xzf "/tmp/${APP_NAME}-release.tgz" -C "${NEW_RELEASE}"
          rm -f "/tmp/${APP_NAME}-release.tgz"

          test -f "${NEW_RELEASE}/server.js"
          test -f "${SHARED_DIR}/.env.production"

          ln -sfn "${NEW_RELEASE}" "${CURRENT_LINK}"

          if [ -f "${SHARED_DIR}/ecosystem.config.js" ]; then
            pm2 startOrRestart "${SHARED_DIR}/ecosystem.config.js" --only "${APP_NAME}" || pm2 restart "${APP_NAME}"
          else
            pm2 restart "${APP_NAME}"
          fi

          curl -fsS "http://127.0.0.1:3000/health" >/dev/null
          echo "âœ… Deployed: ${TS}"
          EOF
