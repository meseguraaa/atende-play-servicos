name: Production Deploy

on:
  push:
    branches: ["main"]

concurrency:
  group: "production"
  cancel-in-progress: true

env:
  APP_NAME: "atendeplay"
  SSH_HOST: ${{ secrets.PROD_SSH_HOST }}
  SSH_USER: ${{ secrets.PROD_SSH_USER }}
  SSH_PORT: ${{ secrets.PROD_SSH_PORT }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Prisma generate (Linux)
        run: pnpm prisma generate

      - name: Guardrail: fail if Prisma engines include darwin
        run: |
          set -euo pipefail
          if find node_modules -path "*@prisma*" -o -path "*\.prisma*" | grep -i darwin; then
            echo "❌ Prisma contains darwin artifacts. Aborting."
            exit 1
          fi

      - name: Build (Next.js)
        run: pnpm build

      # Empacota o build no formato que seu start.sh espera:
      # - server.js (standalone)
      # - .next/static
      # - public (se existir)
      - name: Package release artifact
        run: |
          set -euo pipefail
          rm -rf .release
          mkdir -p .release

          # Next standalone
          test -f .next/standalone/server.js

          cp -R .next/standalone/* .release/

          # Static assets
          mkdir -p .release/.next
          cp -R .next/static .release/.next/static

          # Public (opcional)
          if [ -d "public" ]; then
            cp -R public .release/public
          fi

          # Marca a versão
          echo "${GITHUB_SHA}" > .release/RELEASE_SHA

          # Compacta
          tar -czf release.tgz -C .release .

      - name: Upload artifact (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: release-tgz
          path: release.tgz
          if-no-files-found: error
          retention-days: 3

      - name: Write SSH key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p "${SSH_PORT}" -H "${SSH_HOST}" >> ~/.ssh/known_hosts

      - name: Upload release to server
        run: |
          set -euo pipefail
          scp -P "${SSH_PORT}" release.tgz "${SSH_USER}@${SSH_HOST}:/tmp/${APP_NAME}-release.tgz"

      - name: Deploy on server (atomic symlink switch)
        run: |
          set -euo pipefail
          ssh -p "${SSH_PORT}" "${SSH_USER}@${SSH_HOST}" << 'EOF'
          set -euo pipefail

          APP_NAME="atendeplay"
          BASE_DIR="/home/deploy/apps/${APP_NAME}"
          RELEASES_DIR="${BASE_DIR}/releases"
          SHARED_DIR="${BASE_DIR}/shared"
          CURRENT_LINK="${BASE_DIR}/current"

          mkdir -p "${RELEASES_DIR}"

          TS="$(date +%Y%m%d%H%M%S)"
          NEW_RELEASE="${RELEASES_DIR}/${TS}"

          mkdir -p "${NEW_RELEASE}"
          tar -xzf "/tmp/${APP_NAME}-release.tgz" -C "${NEW_RELEASE}"
          rm -f "/tmp/${APP_NAME}-release.tgz"

          # Guardrails (não troca symlink se estiver ruim)
          test -f "${NEW_RELEASE}/server.js"
          test -f "${SHARED_DIR}/.env.production"

          # (Opcional) Prisma migrate deploy no servidor, usando o código novo
          # Se seu prisma/schema.prisma estiver dentro do standalone, ok.
          # Caso não esteja, a gente ajusta no próximo passo.
          if [ -f "${NEW_RELEASE}/node_modules/.bin/prisma" ] || command -v prisma >/dev/null 2>&1; then
            echo "Running prisma migrate deploy..."
            cd "${NEW_RELEASE}"
            if [ -f "node_modules/.bin/prisma" ]; then
              ./node_modules/.bin/prisma migrate deploy
            else
              prisma migrate deploy
            fi
          else
            echo "Skipping prisma migrate deploy (prisma not found)."
          fi

          # Switch atômico
          ln -sfn "${NEW_RELEASE}" "${CURRENT_LINK}"

          # Restart
          pm2 startOrRestart "${BASE_DIR}/shared/ecosystem.config.js" --only "${APP_NAME}" || pm2 restart "${APP_NAME}"

          # Smoke test local (Nginx continua sendo a borda)
          curl -fsS "http://127.0.0.1:3000/health" >/dev/null

          echo "✅ Deployed: ${TS}"
          EOF
