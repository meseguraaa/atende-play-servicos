module.exports=[631351,e=>{"use strict";var t=e.i(154154),r=e.i(140407),n=e.i(493068),i=e.i(821498),a=e.i(161599),o=e.i(182716),s=e.i(857635),l=e.i(337047),u=e.i(528171),d=e.i(367300),c=e.i(102610),p=e.i(670893),m=e.i(902769),h=e.i(46094),f=e.i(622730),y=e.i(811178),g=e.i(193695);e.i(629399);var R=e.i(377404),v=e.i(738342),w=e.i(698043),N=e.i(453852);function b(){return{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, x-company-id"}}function E(e,t){let r=t.toLowerCase();for(let[t,n]of e.headers.entries())if(t.toLowerCase()===r){let e=String(n??"").trim();return e.length?e:null}return null}async function A(e){let t=e.headers.get("authorization")||"",r=t.startsWith("Bearer ")?t.slice(7).trim():"";if(!r)throw Error("missing_token");let n=await (0,N.verifyAppJwt)(r),i="string"==typeof n?.sub?String(n.sub).trim():"";if(!i)throw Error("invalid_token");let a="string"==typeof n?.companyId?String(n.companyId).trim():"";if(!a){let t=E(e,"x-company-id");t&&(a=t)}if(!a)throw Error("missing_company_id");if(!await w.prisma.companyMember.findFirst({where:{userId:i,companyId:a,isActive:!0},select:{id:!0,role:!0}}))throw Error("forbidden_company");return{...n,sub:i,companyId:a}}let P={DIAMANTE:["DIAMANTE","OURO","PRATA","BRONZE"],OURO:["OURO","PRATA","BRONZE"],PRATA:["PRATA","BRONZE"],BRONZE:["BRONZE"]};function T(e,t){let r=new Intl.DateTimeFormat("en-US",{timeZone:t,year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(e),n=e=>r.find(t=>t.type===e)?.value;return{year:Number(n("year")),month:Number(n("month")),day:Number(n("day"))}}function C(e,t,r){return new Date(`${String(e).padStart(4,"0")}-${String(t).padStart(2,"0")}-${String(r).padStart(2,"0")}T00:00:00Z`)}function I(e,t){let r=new Date(e.getTime());return r.setUTCDate(r.getUTCDate()+t),r}function S(e){return Number.isFinite(e)?Math.max(0,Math.min(100,Math.floor(e))):0}function x(e){return Math.round((e+Number.EPSILON)*100)/100}function O(e,t){let r=S(t);return x((Number.isFinite(e)?e:0)*(1-r/100))}async function _(e){let t=e.timeZone??"America/Sao_Paulo",r=e.now??new Date,n=e.effectiveLevel??"BRONZE",i=e.product,a=new Map;for(let t of e.discountRows)a.set(t.level,S(Number(t.discountPct)));function o(e){for(let t of P[e])if(a.has(t))return{level:t,discountPct:a.get(t)};return{level:"BRONZE",discountPct:0}}let s=function(e){if(null==e)return NaN;if("number"==typeof e)return e;if("string"==typeof e){let t=Number(e.replace(",","."));return Number.isFinite(t)?t:NaN}if("object"==typeof e)try{let t="function"==typeof e.toString?String(e.toString()):"",r=Number(t.replace(",","."));return Number.isFinite(r)?r:NaN}catch{return NaN}let t=Number(e);return Number.isFinite(t)?t:NaN}(i.price),l=!1;if(e.clientBirthday&&i.birthdayBenefitEnabled){var u;let n,i=T(r,t),a=T(e.clientBirthday,t),o=C(i.year,a.month,a.day),s=I(o,-3),d=I(o,3);u=C(i.year,i.month,i.day),l=(n=u.getTime())>=s.getTime()&&n<=d.getTime()}if(l&&i.birthdayBenefitEnabled){let e=o(i.birthdayPriceLevel??"DIAMANTE"),t=O(s,e.discountPct);return{unitId:i.unitId,basePrice:s,finalPrice:t,discountPct:e.discountPct,appliedLevel:e.level,appliedBecause:"BIRTHDAY",inBirthdayWindow:!0}}let d=o(n),c=O(s,d.discountPct);return{unitId:i.unitId,basePrice:s,finalPrice:c,discountPct:d.discountPct,appliedLevel:d.level,appliedBecause:d.discountPct>0?"LEVEL":"BASE",inBirthdayWindow:!1}}async function B(){return new v.NextResponse(null,{status:204,headers:b()})}async function D(e){let t=b();try{var r,n;let i,a=await A(e),o=a.companyId,s=function(e){let t=E(e,"x-forwarded-proto"),r=E(e,"x-forwarded-host")||E(e,"host"),n=String(t??"").split(",")[0].trim().toLowerCase(),i=String(r??"").split(",")[0].trim();if(i)return`${"http"===n||"https"===n?n:"https"}://${i}`;try{return new URL(e.url).origin}catch{return""}}(e),l=E(e,"x-company-id");if(l&&l!==o)return v.NextResponse.json({error:"company_id_mismatch"},{status:400,headers:t});let u=new URL(e.url),d=(u.searchParams.get("unit")??"all").trim(),c=(u.searchParams.get("q")??"").trim(),p=(u.searchParams.get("category")??"").trim(),m=(u.searchParams.get("inStock")??"").trim(),h=(u.searchParams.get("cursor")??"").trim(),f=(r=u.searchParams.get("limit"),i=Number(r),!Number.isFinite(i)||i<=0?20:Math.min(50,Math.floor(i))),y="all"===d||""===d,g=null;if(!y){let e=await w.prisma.unit.findFirst({where:{id:d,isActive:!0,companyId:o},select:{id:!0}});if(!e)return v.NextResponse.json({error:"invalid_unit"},{status:400,headers:t});g=e.id}let R="1"===m||"true"===m.toLowerCase()||"yes"===m.toLowerCase(),N={isActive:!0,companyId:o,unit:{companyId:o},...g?{unitId:g}:{},...R?{stockQuantity:{gt:0}}:{},...p?{category:p}:{},...c?{OR:[{name:{contains:c,mode:"insensitive"}},{description:{contains:c,mode:"insensitive"}}]}:{}},b=await w.prisma.product.findMany({where:N,orderBy:[{createdAt:"desc"},{id:"desc"}],take:f+1,...h?{cursor:{id:h},skip:1}:{},include:{unit:{select:{id:!0,name:!0}}}}),P=b.length>f,T=P?b.slice(0,f):b,C="CLIENT"===a.role?a.sub:null,I=C?await w.prisma.user.findFirst({where:{id:C},select:{id:!0,birthday:!0}}):null,O=Array.from(new Set(T.map(e=>e.unitId))).filter(Boolean),B=new Map;if(C&&O.length>0)for(let e of(await w.prisma.customerLevelState.findMany({where:{companyId:o,userId:C,unitId:{in:O}},select:{unitId:!0,levelCurrent:!0}}))){let t=(n=e.levelCurrent,"BRONZE"===n||"PRATA"===n||"OURO"===n||"DIAMANTE"===n?n:null);t&&B.set(e.unitId,t)}let D=T.map(e=>e.id),M=D.length?await w.prisma.productDiscountByLevel.findMany({where:{companyId:o,productId:{in:D}},select:{productId:!0,level:!0,discountPct:!0}}):[],k=new Map;for(let e of M){let t=String(e.productId),r=k.get(t)??[];r.push({productId:t,level:e.level,discountPct:e.discountPct}),k.set(t,r)}let L=new Date,U=await Promise.all(T.map(async e=>{let t="number"==typeof e.pickupDeadlineDays&&Number.isFinite(e.pickupDeadlineDays)&&e.pickupDeadlineDays>0?e.pickupDeadlineDays:2,r="number"==typeof e.stockQuantity?e.stockQuantity:0,n=B.get(e.unitId)??"BRONZE",i=await _({product:{id:e.id,price:e.price,unitId:e.unitId,birthdayBenefitEnabled:!!e.birthdayBenefitEnabled,birthdayPriceLevel:e.birthdayPriceLevel??null},clientBirthday:I?.birthday??null,effectiveLevel:n,timeZone:"America/Sao_Paulo",now:L,discountRows:k.get(e.id)??[]}),a=Number(i.basePrice),o=Number(i.finalPrice),l=S(Number(i.discountPct)),u=Number.isFinite(a)&&Number.isFinite(o)&&a>0&&o<a,d=u?x(Math.max(0,a-o)):0,c="BIRTHDAY"===i.appliedBecause?{type:"BIRTHDAY",label:"ðŸŽ‚ AniversÃ¡rio"}:"LEVEL"===i.appliedBecause&&u?{type:"LEVEL",label:"â­ Oferta do seu nÃ­vel"}:null,p=function(e,t){let r=String(t??"").trim();if(!r)return null;let n=r.toLowerCase();if(n.startsWith("http://")||n.startsWith("https://"))return r;let i=r.startsWith("/")?r:`/${r}`,a=String(e??"").trim();if(!a)return i;let o=a.endsWith("/")?a.slice(0,-1):a;return`${o}${i}`}(s,e.imageUrl);return{id:e.id,name:e.name,imageUrl:p,description:e.description,category:e.category??null,stockQuantity:r,isOutOfStock:r<=0,pickupDeadlineDays:t,unitId:e.unitId,unitName:e.unit?.name??"â€”",basePrice:a,finalPrice:o,discountPct:l,savings:d,hasDiscount:u,price:o,pricing:{customerLevel:n,appliedLevel:i.appliedLevel,appliedBecause:i.appliedBecause,inBirthdayWindow:i.inBirthdayWindow,discountPct:l},badge:c}})),F=P?U[U.length-1]?.id??null:null,H=v.NextResponse.json({ok:!0,items:U,products:U,count:U.length,nextCursor:F},{status:200,headers:t});return H.headers.set("x-company-id",o),H}catch(r){let e=String(r?.message??"");if(e.includes("missing_token"))return v.NextResponse.json({error:"missing_token"},{status:401,headers:t});if(e.includes("missing_company_id"))return v.NextResponse.json({error:"missing_company_id"},{status:401,headers:t});if(e.includes("forbidden_company"))return v.NextResponse.json({error:"forbidden_company"},{status:403,headers:t});if(e.includes("Invalid token")||e.includes("JWT")||e.toLowerCase().includes("token")||e.includes("invalid_token"))return v.NextResponse.json({error:"invalid_token"},{status:401,headers:t});return console.error("[mobile products] error:",r),v.NextResponse.json({error:"server_error"},{status:500,headers:t})}}e.s(["GET",()=>D,"OPTIONS",()=>B,"dynamic",0,"force-dynamic"],560040);var M=e.i(560040);let k=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/mobile/products/route",pathname:"/api/mobile/products",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/mobile/products/route.ts",nextConfigOutput:"standalone",userland:M}),{workAsyncStorage:L,workUnitAsyncStorage:U,serverHooks:F}=k;function H(){return(0,n.patchFetch)({workAsyncStorage:L,workUnitAsyncStorage:U})}async function $(e,t,n){k.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/mobile/products/route";v=v.replace(/\/index$/,"")||"/";let w=await k.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:N,params:b,nextConfig:E,parsedUrl:A,isDraftMode:P,prerenderManifest:T,routerServerContext:C,isOnDemandRevalidate:I,revalidateOnlyGenerated:S,resolvedPathname:x,clientReferenceManifest:O,serverActionsManifest:_}=w,B=(0,l.normalizeAppPath)(v),D=!!(T.dynamicRoutes[B]||T.routes[x]),M=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,A,!1):t.end("This page could not be found"),null);if(D&&!P){let e=!!T.routes[x],t=T.dynamicRoutes[B];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await M();throw new g.NoFallbackError}}let L=null;!D||k.isDev||P||(L="/index"===(L=x)?"/":L);let U=!0===k.isDev||!D,F=D&&!U;_&&O&&(0,o.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:O,serverActionsManifest:_,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:_})});let H=e.method||"GET",$=(0,a.getTracer)(),j=$.getActiveScopeSpan(),q={params:b,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>k.onRequestError(e,t,n,C)},sharedContext:{buildId:N}},Z=new u.NodeNextRequest(e),W=new u.NodeNextResponse(t),K=d.NextRequestAdapter.fromNodeNextRequest(Z,(0,d.signalFromNodeResponse)(t));try{let o=async e=>k.handle(K,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${v}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var a,l;let u=async({previousCacheEntry:r})=>{try{if(!s&&I&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(i);e.fetchMetrics=q.renderOpts.fetchMetrics;let l=q.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=q.renderOpts.collectedTags;if(!D)return await (0,m.sendResponse)(Z,W,a,q.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[y.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,n=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:I})},C),t}},d=await k.handleResponse({req:e,nextConfig:E,cacheKey:L,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:S,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:s});if(!D)return null;if((null==d||null==(a=d.value)?void 0:a.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",I?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&D||c.delete(y.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(Z,W,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};j?await l(j):await $.withPropagatedContext(e.headers,()=>$.trace(c.BaseServerSpan.handleRequest,{spanName:`${H} ${v}`,kind:a.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:B,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:I})}),D)throw t;return await (0,m.sendResponse)(Z,W,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>H,"routeModule",()=>k,"serverHooks",()=>F,"workAsyncStorage",()=>L,"workUnitAsyncStorage",()=>U],631351)}];

//# sourceMappingURL=c2dd8_next_dist_esm_build_templates_app-route_280371c4.js.map