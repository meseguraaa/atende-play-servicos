module.exports=[918622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},120635,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/action-async-storage.external.js",()=>require("next/dist/server/app-render/action-async-storage.external.js"))},860827,e=>{"use strict";var t=e.i(154154),r=e.i(140407),a=e.i(493068),n=e.i(821498),i=e.i(161599),o=e.i(182716),s=e.i(857635),l=e.i(337047),d=e.i(528171),u=e.i(367300),c=e.i(102610),p=e.i(670893),m=e.i(902769),v=e.i(46094),g=e.i(622730),y=e.i(811178),f=e.i(193695);e.i(629399);var h=e.i(377404),R=e.i(738342),x=e.i(387148),w=e.i(774785),E=e.i(698043),I=e.i(212669);let A=["BRONZE","PRATA","OURO","DIAMANTE"],C=["HAS_ACTIVE_PLAN"];function S(e,t){return R.NextResponse.json({ok:!0,data:e},t)}function N(e,t=400){return R.NextResponse.json({ok:!1,error:e},{status:t})}async function k(e){let t=String(e?.companyId??"").trim();if(t)return t;let r=await (0,x.cookies)(),a=String(r.get("admin_company_context")?.value??r.get("companyId")?.value??"").trim();return a||""}function b(e){return String(e??"").trim(),"HAS_ACTIVE_PLAN"}function T(e){let t=String(e??"").trim();return A.includes(t)?t:"BRONZE"}function U(e,t=0){let r=Number.parseInt(String(e??""),10);return!Number.isFinite(r)||Number.isNaN(r)?t:Math.max(0,r)}function _(e,t){if(e&&"function"==typeof e.get)return e.get(t)}async function P(e){let t=await (0,I.requireAdminForModule)("CLIENT_LEVELS"),r=await k(t);if(!r)return{ok:!1,status:400,error:"Contexto de empresa ausente (companyId)."};let a=await (0,x.cookies)(),n=String(a.get("admin_unit_context")?.value??"").trim()||"all",i=!!t?.canSeeAllUnits,o=String(e.requestedUnitId??"").trim(),s=await E.prisma.unit.findMany({where:{companyId:r},orderBy:{name:"asc"},select:{id:!0,name:!0,isActive:!0}});if(!i){if("all"===n){let e=s.find(e=>e.isActive)?.id??s[0]?.id;return e?{ok:!0,companyId:r,canSeeAllUnits:i,unitCookie:n,units:s=s.filter(t=>t.id===e),activeUnitId:e}:{ok:!1,status:400,error:"Nenhuma unidade encontrada para o contexto atual."}}return s.some(e=>e.id===n)?(s=s.filter(e=>e.id===n),{ok:!0,companyId:r,canSeeAllUnits:i,unitCookie:n,units:s,activeUnitId:n}):{ok:!1,status:400,error:"Unidade do contexto (cookie) inválida para esta empresa."}}let l=o&&"all"!==o&&s.some(e=>e.id===o)?o:n&&"all"!==n&&s.some(e=>e.id===n)?n:s.find(e=>e.isActive)?.id??s[0]?.id??null;return l?{ok:!0,companyId:r,canSeeAllUnits:i,unitCookie:n,units:s,activeUnitId:l}:{ok:!1,status:400,error:"Nenhuma unidade encontrada para o contexto atual."}}async function O(e){try{let{searchParams:t}=new URL(e.url),r=t.get("unitId"),a=await P({requestedUnitId:r});if(!a.ok)return N(a.error,a.status);let n=await E.prisma.customerLevelRule.findMany({where:{companyId:a.companyId,unitId:a.activeUnitId},orderBy:[{priority:"desc"},{createdAt:"asc"}],select:{id:!0,type:!0,targetLevel:!0,priority:!0,isEnabled:!0}});return S({scope:{companyId:a.companyId,canSeeAllUnits:a.canSeeAllUnits,unitCookie:a.unitCookie},units:a.units,activeUnitId:a.activeUnitId,levels:A,ruleTypes:C,rules:n.map(e=>({id:e.id,type:String(e.type),targetLevel:String(e.targetLevel),priority:e.priority,isEnabled:e.isEnabled}))})}catch(e){if((0,w.isRedirectError)(e))throw e;return N("string"==typeof e?.message?e.message:"Erro inesperado ao carregar regras.",500)}}async function q(e){try{let t=await e.formData(),r=String(_(t,"intent")??"").trim(),a=String(_(t,"unitId")??"").trim(),n=await P({requestedUnitId:a});if(!n.ok)return N(n.error,n.status);let i=n.activeUnitId;if("create"===r){if(await E.prisma.customerLevelRule.count({where:{companyId:n.companyId,unitId:i}})>0)return N("Esta unidade já possui uma regra. Exclua para criar outra.",400);let e=b(_(t,"type")),r=T(_(t,"targetLevel")),a=U(_(t,"priority"),100),o=await E.prisma.customerLevelRule.create({data:{companyId:n.companyId,unitId:i,type:e,targetLevel:r,priority:a,isEnabled:!0},select:{id:!0}});return S({saved:!0,intent:"create",ruleId:o.id})}if("update"===r){let e=String(_(t,"ruleId")??"").trim();if(!e)return N("ruleId é obrigatório.",400);let r=b(_(t,"type")),a=T(_(t,"targetLevel")),o=U(_(t,"priority"),100);return await E.prisma.customerLevelRule.updateMany({where:{id:e,companyId:n.companyId,unitId:i},data:{type:r,targetLevel:a,priority:o}}),S({saved:!0,intent:"update",ruleId:e})}if("delete"===r){let e=String(_(t,"ruleId")??"").trim();if(!e)return N("ruleId é obrigatório.",400);return await E.prisma.customerLevelRule.deleteMany({where:{id:e,companyId:n.companyId,unitId:i}}),S({saved:!0,intent:"delete",ruleId:e})}return N("Intent inválida. Use create, update ou delete.",400)}catch(e){if((0,w.isRedirectError)(e))throw e;return N("string"==typeof e?.message?e.message:"Erro inesperado ao salvar regras.",500)}}e.s(["GET",()=>O,"POST",()=>q,"dynamic",0,"force-dynamic"],312615);var L=e.i(312615);let M=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/client-levels/rules/route",pathname:"/api/admin/client-levels/rules",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/admin/client-levels/rules/route.ts",nextConfigOutput:"standalone",userland:L}),{workAsyncStorage:j,workUnitAsyncStorage:H,serverHooks:D}=M;function F(){return(0,a.patchFetch)({workAsyncStorage:j,workUnitAsyncStorage:H})}async function B(e,t,a){M.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/admin/client-levels/rules/route";R=R.replace(/\/index$/,"")||"/";let x=await M.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!x)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:E,nextConfig:I,parsedUrl:A,isDraftMode:C,prerenderManifest:S,routerServerContext:N,isOnDemandRevalidate:k,revalidateOnlyGenerated:b,resolvedPathname:T,clientReferenceManifest:U,serverActionsManifest:_}=x,P=(0,l.normalizeAppPath)(R),O=!!(S.dynamicRoutes[P]||S.routes[T]),q=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,A,!1):t.end("This page could not be found"),null);if(O&&!C){let e=!!S.routes[T],t=S.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await q();throw new f.NoFallbackError}}let L=null;!O||M.isDev||C||(L="/index"===(L=T)?"/":L);let j=!0===M.isDev||!O,H=O&&!j;_&&U&&(0,o.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:U,serverActionsManifest:_,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:_})});let D=e.method||"GET",F=(0,i.getTracer)(),B=F.getActiveScopeSpan(),$={params:E,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>M.onRequestError(e,t,a,N)},sharedContext:{buildId:w}},K=new d.NodeNextRequest(e),V=new d.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let o=async e=>M.handle(G,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${D} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${R}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&k&&b&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(n);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=$.renderOpts.collectedTags;if(!O)return await (0,m.sendResponse)(K,V,i,$.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,v.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[y.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,a=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await M.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:k})},N),t}},u=await M.handleResponse({req:e,nextConfig:I,cacheKey:L,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:b,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!O)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",k?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,v.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&O||c.delete(y.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(K,V,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};B?await l(B):await F.withPropagatedContext(e.headers,()=>F.trace(c.BaseServerSpan.handleRequest,{spanName:`${D} ${R}`,kind:i.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await M.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:k})}),O)throw t;return await (0,m.sendResponse)(K,V,new Response(null,{status:500})),null}}e.s(["handler",()=>B,"patchFetch",()=>F,"routeModule",()=>M,"serverHooks",()=>D,"workAsyncStorage",()=>j,"workUnitAsyncStorage",()=>H],860827)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__59ee9cbb._.js.map