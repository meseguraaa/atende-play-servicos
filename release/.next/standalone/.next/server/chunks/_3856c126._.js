module.exports=[896407,e=>{"use strict";var t=e.i(698043),r=e.i(52359);async function n(){let e=await (0,r.getCurrentPainelUser)();if(!e||"PROFESSIONAL"!==e.role)return{companyId:"",professionalId:"",userId:"",unitId:""};let n=String(e.sub||"").trim(),a=String(e.companyId||"").trim();if(!n||!a)return{companyId:"",professionalId:"",userId:"",unitId:""};let i=await t.prisma.professional.findFirst({where:{userId:n,companyId:a,isActive:!0},select:{id:!0,name:!0,email:!0}});if(!i?.id)return{companyId:"",professionalId:"",userId:n,unitId:""};let o=await t.prisma.professionalUnit.findFirst({where:{companyId:a,professionalId:i.id,isActive:!0},select:{unitId:!0},orderBy:{updatedAt:"desc"}});return{companyId:a,professionalId:i.id,userId:n,unitId:o?.unitId??"",name:i.name??null,email:i.email}}e.s(["requireProfessionalSession",()=>n])},725525,e=>{"use strict";var t=e.i(154154),r=e.i(140407),n=e.i(493068),a=e.i(821498),i=e.i(161599),o=e.i(182716),s=e.i(857635),l=e.i(337047),u=e.i(528171),d=e.i(367300),c=e.i(102610),p=e.i(670893),m=e.i(902769),f=e.i(46094),h=e.i(622730),g=e.i(811178),w=e.i(193695);e.i(629399);var R=e.i(377404),v=e.i(738342),y=e.i(698043);function A(e,t=400){return v.NextResponse.json({ok:!1,error:e},{status:t})}async function E(t){try{let r,n=function(){try{let t=e.r(896407),r=t?.requireProfessionalSession??t?.default??t?.requireProfessional;if("function"==typeof r)return r;return null}catch{return null}}();if(!n)return A('Helper de sessão do profissional não encontrado. Crie/ajuste "@/lib/professional-permissions" exportando requireProfessionalSession() com { companyId, professionalId }.',500);let a=await n(),i=a?.companyId,o=a?.professionalId;if(!i)return A("Sessão sem companyId.",401);if(!o)return A("Sessão sem professionalId.",401);let s=t.nextUrl.searchParams.get("month"),l=function(e){if(!e)return null;let t=String(e).trim();if(!/^\d{4}-\d{2}$/.test(t))return null;let[r,n]=t.split("-"),a=Number(r),i=Number(n)-1;return!Number.isFinite(a)||!Number.isFinite(i)||a<2e3||a>2100||i<0||i>11?null:new Date(a,i,1)}(s)??new Date,u=new Date(l.getFullYear(),l.getMonth(),1,0,0,0,0),d=new Date(l.getFullYear(),l.getMonth()+1,0,23,59,59,999),c=(r=new Intl.DateTimeFormat("pt-BR",{month:"long",year:"numeric"}).format(l)).charAt(0).toUpperCase()+r.slice(1),[p,m]=await Promise.all([y.prisma.appointmentReview.findMany({where:{companyId:i,professionalId:o,createdAt:{gte:u,lte:d}},include:{client:!0,appointment:{include:{service:!0}},tags:{include:{tag:!0}}},orderBy:{createdAt:"desc"}}),y.prisma.appointmentReview.findMany({where:{companyId:i,professionalId:o},select:{rating:!0}})]),f=p.map(e=>{let t=e.isAnonymousForProfessional?"Cliente (anônimo)":e.client?.name??"Cliente",r=e.appointment?.service?.name??"Atendimento",n=(e.tags??[]).map(e=>e.tag?.label).filter(Boolean);return{id:e.id,rating:e.rating,comment:e.comment??null,isAnonymousForProfessional:e.isAnonymousForProfessional,clientName:t,serviceName:r,createdAt:e.createdAt.toISOString(),tags:n}}),h=p.length,g=h>0?p.reduce((e,t)=>e+t.rating,0)/h:0,w=m.length,R=w>0?m.reduce((e,t)=>e+t.rating,0)/w:0,E=new Map,I=new Map;for(let e of p){let t=e.rating>=3,r=e.rating<=2;for(let n of e.tags??[]){let e=n.tag?.label;e&&(t&&E.set(e,(E.get(e)??0)+1),r&&I.set(e,(I.get(e)??0)+1))}}let C=Array.from(E.entries()).map(([e,t])=>({label:e,count:t})).sort((e,t)=>t.count!==e.count?t.count-e.count:e.label.localeCompare(t.label)).slice(0,8),S=Array.from(I.entries()).map(([e,t])=>({label:e,count:t})).sort((e,t)=>t.count!==e.count?t.count-e.count:e.label.localeCompare(t.label)).slice(0,8),x=f.filter(e=>e.rating>=3),b=f.filter(e=>e.rating<=2),P=[...x].sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()).slice(0,5),T=[...b].sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()).slice(0,5);return function(e,t=200){return v.NextResponse.json({ok:!0,data:e},{status:t})}({month:{value:`${l.getFullYear()}-${String(l.getMonth()+1).padStart(2,"0")}`,label:c,start:u.toISOString(),end:d.toISOString()},stats:{totalReviewsMonth:h,averageRatingMonth:g,totalReviewsOverall:w,averageRatingOverall:R},topPositiveTags:C,topNegativeTags:S,recentPositiveReviews:P,recentNegativeReviews:T,reviews:f})}catch(e){return console.error("GET /api/professional/review error:",e),A("Erro inesperado ao carregar avaliações.",500)}}e.s(["GET",()=>E],585270);var I=e.i(585270);let C=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/professional/review/route",pathname:"/api/professional/review",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/professional/review/route.ts",nextConfigOutput:"standalone",userland:I}),{workAsyncStorage:S,workUnitAsyncStorage:x,serverHooks:b}=C;function P(){return(0,n.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:x})}async function T(e,t,n){C.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/professional/review/route";v=v.replace(/\/index$/,"")||"/";let y=await C.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:A,params:E,nextConfig:I,parsedUrl:S,isDraftMode:x,prerenderManifest:b,routerServerContext:P,isOnDemandRevalidate:T,revalidateOnlyGenerated:N,resolvedPathname:O,clientReferenceManifest:M,serverActionsManifest:D}=y,F=(0,l.normalizeAppPath)(v),U=!!(b.dynamicRoutes[F]||b.routes[O]),_=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,S,!1):t.end("This page could not be found"),null);if(U&&!x){let e=!!b.routes[O],t=b.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await _();throw new w.NoFallbackError}}let q=null;!U||C.isDev||x||(q="/index"===(q=O)?"/":q);let H=!0===C.isDev||!U,k=U&&!H;D&&M&&(0,o.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:M,serverActionsManifest:D,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:D})});let $=e.method||"GET",j=(0,i.getTracer)(),B=j.getActiveScopeSpan(),K={params:E,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>C.onRequestError(e,t,n,P)},sharedContext:{buildId:A}},L=new u.NodeNextRequest(e),G=new u.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest(L,(0,d.signalFromNodeResponse)(t));try{let o=async e=>C.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${$} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${v}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var i,l;let u=async({previousCacheEntry:r})=>{try{if(!s&&T&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(a);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=K.renderOpts.collectedTags;if(!U)return await (0,m.sendResponse)(L,G,i,K.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[g.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:T})},P),t}},d=await C.handleResponse({req:e,nextConfig:I,cacheKey:q,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:s});if(!U)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",T?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&U||c.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(L,G,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};B?await l(B):await j.withPropagatedContext(e.headers,()=>j.trace(c.BaseServerSpan.handleRequest,{spanName:`${$} ${v}`,kind:i.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:T})}),U)throw t;return await (0,m.sendResponse)(L,G,new Response(null,{status:500})),null}}e.s(["handler",()=>T,"patchFetch",()=>P,"routeModule",()=>C,"serverHooks",()=>b,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>x],725525)}];

//# sourceMappingURL=_3856c126._.js.map