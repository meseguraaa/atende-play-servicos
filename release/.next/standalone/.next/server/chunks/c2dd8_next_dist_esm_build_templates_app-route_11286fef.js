module.exports=[294500,e=>{"use strict";var t=e.i(154154),i=e.i(140407),a=e.i(493068),r=e.i(821498),n=e.i(161599),s=e.i(182716),o=e.i(857635),l=e.i(337047),d=e.i(528171),u=e.i(367300),p=e.i(102610),c=e.i(670893),f=e.i(902769),m=e.i(46094),h=e.i(622730),v=e.i(811178),y=e.i(193695);e.i(629399);var w=e.i(377404),R=e.i(738342),T=e.i(698043),g=e.i(896407),E=e.i(29173);function I(e,t=200){return R.NextResponse.json({ok:!0,data:e},{status:t})}function A(e,t=400){return R.NextResponse.json({ok:!1,error:e},{status:t})}function C(e){return String(e??"").trim()}function b(e){return/^\d{2}:\d{2}$/.test(e)}function N(e){let[t,i]=e.split(":").map(Number);return 60*t+i}async function M(e){return!!await T.prisma.professionalUnit.findFirst({where:{companyId:e.companyId,professionalId:e.professionalId,unitId:e.unitId,isActive:!0},select:{id:!0}})}async function x(e){try{let t=await (0,g.requireProfessionalSession)(),i=C(t.companyId),a=C(t.professionalId),r=C(t.userId);if(!i||!a||!r)return A("Sessão do profissional inválida.",401);let{searchParams:n}=new URL(e.url),s=C(n.get("unitId")),o=C(n.get("professionalId")),l=C(n.get("date")),d=C(n.get("serviceId")),u=C(n.get("appointmentId"));if(!s)return A("unitId é obrigatório.",400);if(!l)return A("date é obrigatório (yyyy-MM-dd).",400);if(o&&o!==a)return A("professionalId inválido para a sessão.",403);let p=function(e){if(!e)return null;let[t,i,a]=e.split("-").map(Number);return t&&i&&a?{y:t,m:i,d:a}:null}(l);if(!p)return A("date inválido. Use yyyy-MM-dd.",400);if(!await T.prisma.unit.findFirst({where:{id:s,companyId:i,isActive:!0},select:{id:!0}}))return A("Unidade inválida ou inativa.",404);if(!await M({companyId:i,professionalId:a,unitId:s}))return A("Sem acesso a esta unidade.",403);if(u&&!await T.prisma.appointment.findFirst({where:{id:u,companyId:i,professionalId:a},select:{id:!0}}))return A("Agendamento inválido para edição.",404);let c=30;if(d){let e=await T.prisma.service.findFirst({where:{id:d,companyId:i,isActive:!0,OR:[{unitId:s},{unitId:null}]},select:{id:!0,durationMinutes:!0}});if(!e)return A("Serviço inválido para esta unidade.",404);c=Math.max(1,Number(e.durationMinutes||30))}let f=new Date(Date.UTC(p.y,p.m-1,p.d,12,0,0,0)),m=await T.prisma.professionalDailyAvailability.findFirst({where:{companyId:i,professionalId:a,unitId:s,date:f},include:{intervals:!0}});if(m?.type===E.ProfessionalDailyAvailabilityType.DAY_OFF)return I({date:l,unitId:s,professionalId:a,source:"DAY_OFF",durationMinutes:c,times:[]});let h=[];if(m&&m.type===E.ProfessionalDailyAvailabilityType.CUSTOM)h=m.intervals.map(e=>({startTime:e.startTime,endTime:e.endTime})).filter(e=>b(e.startTime)&&b(e.endTime)&&e.startTime<e.endTime);else{let e,t,r,n=(e=new Date(Date.UTC(p.y,p.m-1,p.d,12,0,0,0)),t=new Intl.DateTimeFormat("en-US",{timeZone:"America/Sao_Paulo",weekday:"short"}).formatToParts(e),(r=(t.find(e=>"weekday"===e.type)?.value??"").toLowerCase()).startsWith("sun")?0:r.startsWith("mon")?1:r.startsWith("tue")?2:r.startsWith("wed")?3:r.startsWith("thu")?4:r.startsWith("fri")?5:6),o=await T.prisma.professionalWeeklyAvailability.findFirst({where:{companyId:i,professionalId:a,unitId:s,weekday:n},include:{intervals:!0}});if(!o||!o.isActive)return I({date:l,unitId:s,professionalId:a,source:"WEEKLY_INACTIVE",durationMinutes:c,times:[]});let d=o.intervals?.[0];if(!d||!b(d.startTime)||!b(d.endTime)||d.startTime>=d.endTime)return I({date:l,unitId:s,professionalId:a,source:"WEEKLY_NO_INTERVAL",durationMinutes:c,times:[]});h=[{startTime:d.startTime,endTime:d.endTime}]}let v=h.flatMap(e=>(function(e,t,i){let a=N(e),r=N(t),n=Math.max(1,Number(i||0)),s=[];for(let e=a;e+n<=r;e+=30)s.push(function(e){let t=String(Math.floor(e/60)).padStart(2,"0"),i=String(e%60).padStart(2,"0");return`${t}:${i}`}(e));return s})(e.startTime,e.endTime,c));v=Array.from(new Set(v)).sort((e,t)=>N(e)-N(t));let{startUtc:y,endUtc:w}=function(e){let{y:t,m:i,d:a}=e,r=Date.UTC(t,i-1,a,3,0,0,0),n=Date.UTC(t,i-1,a+1,3,0,0,0);return{startUtc:new Date(r),endUtc:new Date(n-1)}}(p),R=(await T.prisma.appointment.findMany({where:{companyId:i,unitId:s,professionalId:a,scheduleAt:{gte:y,lte:w},status:{in:["PENDING","DONE"]},...u?{id:{not:u}}:{}},select:{scheduleAt:!0,serviceId:!0,service:{select:{durationMinutes:!0}}}})).map(e=>{var t;let i,a,r,n=(t=new Date(e.scheduleAt),i=new Intl.DateTimeFormat("pt-BR",{timeZone:"America/Sao_Paulo",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(t),a=i.find(e=>"hour"===e.type)?.value??"00",r=i.find(e=>"minute"===e.type)?.value??"00",`${a}:${r}`),s=N(n),o=Math.max(1,Number(e.service?.durationMinutes||30));return{startMins:s,endMins:s+o}});v=v.filter(e=>{let t=N(e),i=t+c;for(let e of R){var a,r;if(a=e.startMins,r=e.endMins,t<r&&a<i)return!1}return!0});try{let e=new Intl.DateTimeFormat("pt-BR",{timeZone:"America/Sao_Paulo",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(new Date),t=Number(e.find(e=>"day"===e.type)?.value??"0"),i=Number(e.find(e=>"month"===e.type)?.value??"0"),a=Number(e.find(e=>"year"===e.type)?.value??"0"),r=Number(e.find(e=>"hour"===e.type)?.value??"0"),n=Number(e.find(e=>"minute"===e.type)?.value??"0");if(a===p.y&&i===p.m&&t===p.d){let e=60*r+n;v=v.filter(t=>N(t)>=e)}}catch{}return I({date:l,unitId:s,professionalId:a,appointmentId:u||null,source:m?"EXCEPTION":"WEEKLY",intervals:h,durationMinutes:c,times:v})}catch(e){return A(e?.message??"Erro ao calcular disponibilidade.",500)}}e.s(["GET",()=>x],324336);var S=e.i(324336);let P=new t.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/professional/availability/times/route",pathname:"/api/professional/availability/times",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/professional/availability/times/route.ts",nextConfigOutput:"standalone",userland:S}),{workAsyncStorage:D,workUnitAsyncStorage:O,serverHooks:U}=P;function _(){return(0,a.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:O})}async function F(e,t,a){P.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/professional/availability/times/route";R=R.replace(/\/index$/,"")||"/";let T=await P.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!T)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:g,params:E,nextConfig:I,parsedUrl:A,isDraftMode:C,prerenderManifest:b,routerServerContext:N,isOnDemandRevalidate:M,revalidateOnlyGenerated:x,resolvedPathname:S,clientReferenceManifest:D,serverActionsManifest:O}=T,U=(0,l.normalizeAppPath)(R),_=!!(b.dynamicRoutes[U]||b.routes[S]),F=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,A,!1):t.end("This page could not be found"),null);if(_&&!C){let e=!!b.routes[S],t=b.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await F();throw new y.NoFallbackError}}let k=null;!_||P.isDev||C||(k="/index"===(k=S)?"/":k);let H=!0===P.isDev||!_,q=_&&!H;O&&D&&(0,s.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:D,serverActionsManifest:O,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:O})});let $=e.method||"GET",W=(0,n.getTracer)(),K=W.getActiveScopeSpan(),L={params:E,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,a)=>P.onRequestError(e,t,a,N)},sharedContext:{buildId:g}},j=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(j,(0,u.signalFromNodeResponse)(t));try{let s=async e=>P.handle(G,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=W.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=i.get("next.route");if(a){let t=`${$} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${R}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var n,l;let d=async({previousCacheEntry:i})=>{try{if(!o&&M&&x&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(r);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!_)return await (0,f.sendResponse)(j,B,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[v.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:a}}}}catch(t){throw(null==i?void 0:i.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:M})},N),t}},u=await P.handleResponse({req:e,nextConfig:I,cacheKey:k,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:M,revalidateOnlyGenerated:x,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!_)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",M?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&_||p.delete(v.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,f.sendResponse)(j,B,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};K?await l(K):await W.withPropagatedContext(e.headers,()=>W.trace(p.BaseServerSpan.handleRequest,{spanName:`${$} ${R}`,kind:n.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:M})}),_)throw t;return await (0,f.sendResponse)(j,B,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>_,"routeModule",()=>P,"serverHooks",()=>U,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>O],294500)}];

//# sourceMappingURL=c2dd8_next_dist_esm_build_templates_app-route_11286fef.js.map