module.exports=[790542,e=>{"use strict";var t=e.i(154154),i=e.i(140407),r=e.i(493068),n=e.i(821498),a=e.i(161599),s=e.i(182716),o=e.i(857635),l=e.i(337047),u=e.i(528171),d=e.i(367300),m=e.i(102610),c=e.i(670893),p=e.i(902769),f=e.i(46094),h=e.i(622730),T=e.i(811178),v=e.i(193695);e.i(629399);var g=e.i(377404),w=e.i(738342),N=e.i(698043),b=e.i(453852);function y(){return{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET,OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}}async function A(e){let t=e.headers.get("authorization")||"",i=t.startsWith("Bearer ")?t.slice(7).trim():"";if(!i)throw Error("missing_token");let r=await (0,b.verifyAppJwt)(i),n="string"==typeof r?.companyId?String(r.companyId).trim():"";if(!n)throw Error("missing_company_id");return{...r,companyId:n}}async function R(){return new w.NextResponse(null,{status:204,headers:y()})}function E(e){return String(e).padStart(2,"0")}function S(e){let t=Math.floor(e/60);return`${E(t)}:${E(e%60)}`}function I(e){let t=String(e??"").trim();if(!t)return"";let i=t.match(/^(\d{1,2}):(\d{2})/);return i?`${E(Number(i[1]))}:${i[2]}`:""}function C(e){let t=String(e??"").match(/^(\d{2}):(\d{2})$/);return t?60*Number(t[1])+Number(t[2]):1/0}function M(e,t=30){let i=Number(e);return!Number.isFinite(i)||i<=0?t:Math.max(1,Math.round(i))}function _(e){return e.map(e=>({startTime:I(e.startTime),endTime:I(e.endTime)})).filter(e=>e.startTime&&e.endTime).map(e=>{let t=C(e.startTime),i=C(e.endTime);return{...e,_s:t,_e:i}}).filter(e=>Number.isFinite(e._s)&&Number.isFinite(e._e)&&e._e>e._s).sort((e,t)=>e._s-t._s)}async function x(e){let t=y();try{var i,r;let n,a=await A(e),s=a.companyId;if(a.role&&"CLIENT"!==a.role)return w.NextResponse.json({ok:!1,error:"Sem permissão"},{status:403,headers:t});let{searchParams:o}=new URL(e.url),l=String(o.get("professionalId")??o.get("barberId")??"").trim(),u=String(o.get("unitId")??"").trim(),d=String(o.get("dateISO")??"").trim(),m=String(o.get("appointmentId")??"").trim(),c=String(o.get("serviceId")??"").trim(),p=function(e){if(!e)return null;let t=Number(e);return!Number.isFinite(t)||t<=0?null:Math.round(t)}(o.get("serviceDurationInMinutes"));if(!l||!u||!d)return w.NextResponse.json({ok:!1,error:"Parâmetros obrigatórios: professionalId (ou barberId), unitId e dateISO"},{status:400,headers:t});let f=new Date(d);if(Number.isNaN(f.getTime()))return w.NextResponse.json({ok:!1,error:"dateISO inválido"},{status:400,headers:t});if(!await N.prisma.unit.findFirst({where:{id:u,companyId:s,isActive:!0},select:{id:!0}}))return w.NextResponse.json({ok:!1,error:"Unidade inválida"},{status:404,headers:t});if(!await N.prisma.professional.findFirst({where:{id:l,companyId:s,isActive:!0},select:{id:!0}}))return w.NextResponse.json({ok:!1,error:"Profissional inválido"},{status:404,headers:t});let h=p;if(!h&&c){let e=await N.prisma.service.findFirst({where:{id:c,companyId:s,isActive:!0},select:{durationMinutes:!0}});if(!e)return w.NextResponse.json({ok:!1,error:"Serviço não encontrado"},{status:404,headers:t});h=Math.max(1,Number(e?.durationMinutes??0))||30}if(!h)return w.NextResponse.json({ok:!1,error:"Informe serviceId ou serviceDurationInMinutes para calcular os horários."},{status:400,headers:t});if(h=M(h,30),!await N.prisma.professionalUnit.findFirst({where:{companyId:s,unitId:u,professionalId:l,isActive:!0},select:{id:!0}}))return w.NextResponse.json({ok:!1,error:"Profissional não vinculado a esta unidade"},{status:400,headers:t});let T=(n=new Intl.DateTimeFormat("en-US",{timeZone:"America/Sao_Paulo",weekday:"short"}).format(f),({Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6})[String(n)]??f.getUTCDay()),{startUtc:v,endUtc:g,dateKey:b}=function(e){let t=new Date(e),i=new Intl.DateTimeFormat("en-CA",{timeZone:"America/Sao_Paulo",year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(t),r=e=>i.find(t=>t.type===e)?.value??"",n=Number(r("year")),a=Number(r("month")),s=Number(r("day"));if(!n||!a||!s){let e=new Date(t);e.setHours(0,0,0,0);let i=new Date(t);return i.setHours(23,59,59,999),{startUtc:e,endUtc:i,dateKey:null}}let o=new Date(Date.UTC(n,a-1,s,3,0,0,0)),l=new Date(Date.UTC(n,a-1,s+1,2,59,59,999));return{startUtc:o,endUtc:l,dateKey:`${n}-${E(a)}-${E(s)}`}}(d),y=await N.prisma.professionalWeeklyAvailability.findFirst({where:{companyId:s,professionalId:l,unitId:u,weekday:T,isActive:!0},include:{intervals:!0}}),R=(y?.intervals??[]).map(e=>({startTime:e.startTime,endTime:e.endTime})).map(e=>({startTime:I(e.startTime),endTime:I(e.endTime)})).filter(e=>e.startTime&&e.endTime),x=await N.prisma.professionalDailyAvailability.findFirst({where:{companyId:s,professionalId:l,unitId:u,date:{gte:v,lte:g}},include:{intervals:!0}}),D="NONE",F=[];x?.type==="DAY_OFF"?(D="DAILY_DAY_OFF",F=[]):x?.type==="CUSTOM"?(D="DAILY_CUSTOM",F=(x?.intervals??[]).map(e=>({startTime:e.startTime,endTime:e.endTime})).map(e=>({startTime:I(e.startTime),endTime:I(e.endTime)})).filter(e=>e.startTime&&e.endTime)):R.length?(D="WEEKLY",F=R):(D="NONE",F=[]);let O=await N.prisma.unitWeeklyAvailability.findFirst({where:{companyId:s,unitId:u,weekday:T,isActive:!0},include:{intervals:!0}}),P=(O?.intervals??[]).map(e=>({startTime:e.startTime,endTime:e.endTime})).map(e=>({startTime:I(e.startTime),endTime:I(e.endTime)})).filter(e=>e.startTime&&e.endTime),k=await N.prisma.unitDailyAvailability.findFirst({where:{companyId:s,unitId:u,date:{gte:v,lte:g}},include:{intervals:!0}}),U="NONE",j=[];k?.isClosed===!0?(U="DAILY_CLOSED",j=[]):k?(U="DAILY_CUSTOM",j=(k?.intervals??[]).map(e=>({startTime:e.startTime,endTime:e.endTime})).map(e=>({startTime:I(e.startTime),endTime:I(e.endTime)})).filter(e=>e.startTime&&e.endTime)):P.length?(U="WEEKLY",j=P):(U="NONE",j=[]);let H=function(e,t){let i=_(e),r=_(t),n=[];if(!i.length||!r.length)return n;let a=0,s=0;for(;a<i.length&&s<r.length;){let e=i[a],t=r[s],o=Math.max(e._s,t._s),l=Math.min(e._e,t._e);l>o&&n.push({startTime:S(o),endTime:S(l)}),e._e<t._e?a++:s++}return n}(F,j);if(!H.length)return w.NextResponse.json({ok:!0,slots:[],meta:{unitId:u,professionalId:l,serviceId:c||null,serviceDurationInMinutes:h,slotIntervalInMinutes:30,appointmentId:m||null,weekday:T,dateKeySaoPaulo:b,professionalAvailabilitySource:D,unitAvailabilitySource:U,hasAvailability:!1}},{status:200,headers:t});let $=new Set;for(let e of H)for(let t of function(e){let t=C(I(e.startTime)),i=C(I(e.endTime)),r=Number.isFinite(e.durationMin)&&e.durationMin>0?e.durationMin:30,n=Number.isFinite(e.stepMin)&&e.stepMin>0?e.stepMin:30;if(!Number.isFinite(t)||!Number.isFinite(i)||i<=t)return[];let a=i-r;if(!Number.isFinite(a)||a<t)return[];let s=[];for(let e=t;e<=a;e+=n)s.push(S(e));return s}({startTime:e.startTime,endTime:e.endTime,durationMin:h,stepMin:30}))$.add(t);let L=Array.from($).sort((e,t)=>C(e)-C(t)),q=(await N.prisma.appointment.findMany({where:{companyId:s,unitId:u,professionalId:l,status:{not:"CANCELED"},scheduleAt:{gte:v,lte:g},...m?{id:{not:m}}:{}},select:{id:!0,scheduleAt:!0,service:{select:{durationMinutes:!0}}},orderBy:{scheduleAt:"asc"}})??[]).map(e=>{var t;let i,r,n,a,s,o,l=(t=new Date(e.scheduleAt),C((i=new Intl.DateTimeFormat("en-US",{timeZone:"America/Sao_Paulo",hour:"2-digit",minute:"2-digit",hour12:!1}).formatToParts(t),n=(r=e=>i.find(t=>t.type===e)?.value??"")("hour"),a=r("minute"),s=Number(n),o=Number(a),Number.isFinite(s)&&Number.isFinite(o)?`${E(s)}:${E(o)}`:""))),u=M(e?.service?.durationMinutes??30,30),d=l+u;return!Number.isFinite(l)||l<0||!Number.isFinite(d)||d<=l?null:{startMin:l,endMin:d}}).filter(Boolean);if(q.length&&(L=L.filter(e=>{let t=C(I(e));if(!Number.isFinite(t))return!1;let i=t+h;for(let e of q){var r,n;if(r=e.startMin,n=e.endMin,t<n&&i>r)return!1}return!0})),m){let e=await N.prisma.appointment.findFirst({where:{id:m,companyId:s,clientId:a.sub,status:{not:"CANCELED"}},select:{id:!0,scheduleAt:!0,unitId:!0,professionalId:!0}});if(e&&String(e.unitId??"")===u&&String(e.professionalId??"")===l&&(i=new Date(e.scheduleAt),i.getFullYear()===f.getFullYear()&&i.getMonth()===f.getMonth()&&i.getDate()===f.getDate())){let t=(r=new Date(e.scheduleAt),`${E(r.getHours())}:${E(r.getMinutes())}`);t&&!L.includes(t)&&(L=[t,...L])}}return w.NextResponse.json({ok:!0,slots:L,meta:{unitId:u,professionalId:l,serviceId:c||null,serviceDurationInMinutes:h,slotIntervalInMinutes:30,appointmentId:m||null,weekday:T,dateKeySaoPaulo:b,professionalAvailabilitySource:D,unitAvailabilitySource:U,effectiveIntervals:H,busyCount:q.length,hasAvailability:L.length>0}},{status:200,headers:t})}catch(i){let e=String(i?.message??"Não autorizado").toLowerCase();if(e.includes("missing_token")||e.includes("missing_company_id")||e.includes("token")||e.includes("jwt")||e.includes("signature")||e.includes("companyid"))return w.NextResponse.json({ok:!1,error:"Não autorizado"},{status:401,headers:t});return console.error("[api/mobile/availability] error:",i),w.NextResponse.json({ok:!1,error:"Erro ao buscar disponibilidade"},{status:500,headers:t})}}e.s(["GET",()=>x,"OPTIONS",()=>R,"runtime",0,"nodejs"],222266);var D=e.i(222266);let F=new t.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/mobile/availability/route",pathname:"/api/mobile/availability",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/mobile/availability/route.ts",nextConfigOutput:"standalone",userland:D}),{workAsyncStorage:O,workUnitAsyncStorage:P,serverHooks:k}=F;function U(){return(0,r.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:P})}async function j(e,t,r){F.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/mobile/availability/route";w=w.replace(/\/index$/,"")||"/";let N=await F.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!N)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:b,params:y,nextConfig:A,parsedUrl:R,isDraftMode:E,prerenderManifest:S,routerServerContext:I,isOnDemandRevalidate:C,revalidateOnlyGenerated:M,resolvedPathname:_,clientReferenceManifest:x,serverActionsManifest:D}=N,O=(0,l.normalizeAppPath)(w),P=!!(S.dynamicRoutes[O]||S.routes[_]),k=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,R,!1):t.end("This page could not be found"),null);if(P&&!E){let e=!!S.routes[_],t=S.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await k();throw new v.NoFallbackError}}let U=null;!P||F.isDev||E||(U="/index"===(U=_)?"/":U);let j=!0===F.isDev||!P,H=P&&!j;D&&x&&(0,s.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:x,serverActionsManifest:D,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:D})});let $=e.method||"GET",L=(0,a.getTracer)(),q=L.getActiveScopeSpan(),K={params:y,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,r)=>F.onRequestError(e,t,r,I)},sharedContext:{buildId:b}},Y=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(Y,(0,d.signalFromNodeResponse)(t));try{let s=async e=>F.handle(W,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=L.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=i.get("next.route");if(r){let t=`${$} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${w}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var a,l;let u=async({previousCacheEntry:i})=>{try{if(!o&&C&&M&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=K.renderOpts.collectedTags;if(!P)return await (0,p.sendResponse)(Y,B,a,K.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[T.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=T.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=T.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:r}}}}catch(t){throw(null==i?void 0:i.isStale)&&await F.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},I),t}},d=await F.handleResponse({req:e,nextConfig:A,cacheKey:U,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:M,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:o});if(!P)return null;if((null==d||null==(a=d.value)?void 0:a.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&P||m.delete(T.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(Y,B,new Response(d.value.body,{headers:m,status:d.value.status||200})),null};q?await l(q):await L.withPropagatedContext(e.headers,()=>L.trace(m.BaseServerSpan.handleRequest,{spanName:`${$} ${w}`,kind:a.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await F.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})}),P)throw t;return await (0,p.sendResponse)(Y,B,new Response(null,{status:500})),null}}e.s(["handler",()=>j,"patchFetch",()=>U,"routeModule",()=>F,"serverHooks",()=>k,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>P],790542)}];

//# sourceMappingURL=c2dd8_next_dist_esm_build_templates_app-route_cd52ef97.js.map