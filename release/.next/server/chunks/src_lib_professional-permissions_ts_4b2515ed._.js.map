{"version":3,"sources":["turbopack:///[project]/src/lib/professional-permissions.ts"],"sourcesContent":["// src/lib/professional-permissions.ts\nimport { prisma } from '@/lib/prisma';\nimport { getCurrentPainelUser } from '@/lib/painel-session';\n\nexport type ProfessionalSession = {\n    companyId: string;\n    professionalId: string;\n    userId: string;\n\n    /**\n     * ✅ Opcional: unidade “default” (quando existe vínculo em ProfessionalUnit).\n     * Não é obrigatório para não quebrar fluxos já existentes.\n     */\n    unitId?: string;\n\n    name?: string | null;\n    email?: string;\n};\n\n/**\n * ✅ Server helper (igual ao padrão do admin):\n * - Usa getCurrentPainelUser() (JWT/cookie do painel)\n * - Valida role PROFESSIONAL\n * - Garante vínculo real do usuário com Professional (companyId + userId)\n *\n * Importante:\n * - NÃO dá redirect aqui (pra não quebrar usos em /api).\n * - Em caso de falha, retorna strings vazias e a route decide 401.\n */\nexport async function requireProfessionalSession(): Promise<ProfessionalSession> {\n    const session = await getCurrentPainelUser();\n\n    if (!session) {\n        return { companyId: '', professionalId: '', userId: '', unitId: '' };\n    }\n\n    // precisa ser PROFESSIONAL\n    if ((session as any).role !== 'PROFESSIONAL') {\n        return { companyId: '', professionalId: '', userId: '', unitId: '' };\n    }\n\n    const userId = String((session as any).sub || '').trim();\n    const companyId = String((session as any).companyId || '').trim();\n\n    if (!userId || !companyId) {\n        return { companyId: '', professionalId: '', userId: '', unitId: '' };\n    }\n\n    // busca o professional vinculado a esse userId + companyId\n    const professional = await prisma.professional.findFirst({\n        where: {\n            userId,\n            companyId,\n            isActive: true,\n        },\n        select: {\n            id: true,\n            name: true,\n            email: true,\n        },\n    });\n\n    if (!professional?.id) {\n        return { companyId: '', professionalId: '', userId, unitId: '' };\n    }\n\n    /**\n     * ✅ Unidade \"default\" (se existir vínculo em ProfessionalUnit)\n     * - Não muda comportamento existente (só adiciona dado)\n     * - Útil para telas que precisem filtrar por unidade sem exigir parâmetro\n     */\n    const professionalUnit = await prisma.professionalUnit.findFirst({\n        where: {\n            companyId,\n            professionalId: professional.id,\n            isActive: true,\n        },\n        select: {\n            unitId: true,\n        },\n        orderBy: {\n            updatedAt: 'desc',\n        },\n    });\n\n    return {\n        companyId,\n        professionalId: professional.id,\n        userId,\n        unitId: professionalUnit?.unitId ?? '',\n        name: professional.name ?? null,\n        email: professional.email,\n    };\n}\n"],"names":[],"mappings":"wCACA,IAAA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,OA2BO,eAAe,IAClB,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,oBAAA,AAAoB,IAE1C,GAAI,CAAC,GAKyB,MALhB,UAKgC,CAAzC,EAAgB,IAAI,CAJrB,MAAO,CAAE,UAAW,GAAI,eAAgB,GAAI,OAAQ,GAAI,OAAQ,EAAG,EAQvE,IAAM,EAAS,OAAQ,EAAgB,GAAG,EAAI,IAAI,IAAI,GAChD,EAAY,OAAQ,EAAgB,SAAS,EAAI,IAAI,IAAI,GAE/D,GAAI,CAAC,GAAU,CAAC,EACZ,MAAO,CAAE,EADc,QACH,GAAI,eAAgB,GAAI,OAAQ,GAAI,OAAQ,EAAG,EAIvE,IAAM,EAAe,MAAM,EAAA,MAAM,CAAC,YAAY,CAAC,SAAS,CAAC,CACrD,MAAO,QACH,YACA,EACA,UAAU,CACd,EACA,OAAQ,CACJ,IAAI,EACJ,MAAM,EACN,MAAO,EACX,CACJ,GAEA,GAAI,CAAC,GAAc,GACf,CADmB,KACZ,CAAE,UAAW,GAAI,eAAgB,UAAI,EAAQ,OAAQ,EAAG,EAQnE,IAAM,EAAmB,MAAM,EAAA,MAAM,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAC7D,MAAO,WACH,EACA,eAAgB,EAAa,EAAE,CAC/B,UAAU,CACd,EACA,OAAQ,CACJ,QAAQ,CACZ,EACA,QAAS,CACL,UAAW,MACf,CACJ,GAEA,MAAO,WACH,EACA,eAAgB,EAAa,EAAE,QAC/B,EACA,OAAQ,GAAkB,QAAU,GACpC,KAAM,EAAa,IAAI,EAAI,KAC3B,MAAO,EAAa,KAAK,AAC7B,CACJ"}