{"version":3,"sources":["turbopack:///[project]/src/app/admin/page.tsx"],"sourcesContent":["// src/app/admin/page.tsx\nimport { redirect } from 'next/navigation';\n\nimport { prisma } from '@/lib/prisma';\nimport { getCurrentPainelUser } from '@/lib/painel-session';\nimport { ADMIN_MENU } from '@/lib/admin-menu';\nimport { canAccess } from '@/lib/admin-access-map';\n\nexport const dynamic = 'force-dynamic';\n\ntype AdminAccessLike = {\n    canAccessDashboard: boolean;\n    canAccessReports: boolean;\n    canAccessCheckout: boolean;\n    canAccessAppointments: boolean;\n    canAccessProfessionals: boolean;\n    canAccessServices: boolean;\n    canAccessReviews: boolean;\n    canAccessProducts: boolean;\n    canAccessClients: boolean;\n    canAccessClientLevels: boolean;\n    canAccessFinance: boolean;\n    canAccessSettings: boolean;\n};\n\nfunction firstAllowedEnabledHref(\n    access: AdminAccessLike | null\n): string | null {\n    if (!access) return null;\n\n    for (const item of ADMIN_MENU) {\n        if (!item.enabled) continue;\n        if (!canAccess(access as any, item.menuKey)) continue;\n        return item.href;\n    }\n\n    return null;\n}\n\nexport default async function AdminIndexPage() {\n    const session = await getCurrentPainelUser();\n\n    if (!session) {\n        redirect('/painel/login?error=credenciais');\n    }\n\n    if (session.role !== 'ADMIN') {\n        redirect('/painel/login?error=permissao');\n    }\n\n    const userId = String((session as any).sub || '').trim();\n    const companyId = String((session as any).companyId || '').trim();\n\n    if (!userId || !companyId) {\n        redirect('/painel/login?error=permissao');\n    }\n\n    const user = await prisma.user.findUnique({\n        where: { id: userId },\n        select: { id: true, isActive: true },\n    });\n\n    if (!user?.id || !user.isActive) {\n        redirect('/painel/login?error=permissao');\n    }\n\n    const membership = await prisma.companyMember.findFirst({\n        where: {\n            userId,\n            companyId,\n            isActive: true,\n            role: { in: ['OWNER', 'ADMIN'] },\n        },\n        select: { role: true },\n    });\n\n    if (!membership?.role) {\n        redirect('/painel/login?error=permissao');\n    }\n\n    const isOwner = membership.role === 'OWNER';\n\n    // OWNER: entra no dashboard (ele pode tudo)\n    if (isOwner) {\n        redirect('/admin/dashboard');\n    }\n\n    // Sub-admin: pega permiss√µes\n    const adminAccess = await prisma.adminAccess.findFirst({\n        where: { companyId, userId },\n        select: {\n            canAccessDashboard: true,\n            canAccessReports: true,\n            canAccessCheckout: true,\n            canAccessAppointments: true,\n            canAccessProfessionals: true,\n            canAccessServices: true,\n            canAccessReviews: true,\n            canAccessProducts: true,\n            canAccessClients: true,\n            canAccessClientLevels: true,\n            canAccessFinance: true,\n            canAccessSettings: true,\n        },\n    });\n\n    if (!adminAccess) {\n        redirect('/painel/login?error=permissao');\n    }\n\n    const next = firstAllowedEnabledHref(adminAccess as any);\n\n    if (!next) {\n        redirect('/painel/login?error=permissao');\n    }\n\n    redirect(next);\n}\n"],"names":[],"mappings":"4WACA,EAAA,CAAA,CAAA,QAAA,IAAA,EAAA,EAAA,CAAA,CAAA,QAEA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QACA,EAAA,EAAA,CAAA,CAAA,QAiCe,eAAe,IAC1B,IAAM,EAAU,MAAM,CAAA,EAAA,EAAA,oBAAA,AAAoB,GAEtC,CAAC,GACD,CAAA,EAAA,EAAA,CADU,OACV,AAAQ,EAAC,mCAGQ,SAAS,CAA1B,EAAQ,IAAI,EACZ,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,iCAGb,IAAM,EAAS,OAAQ,EAAgB,GAAG,EAAI,IAAI,IAAI,GAChD,EAAY,OAAQ,EAAgB,SAAS,EAAI,IAAI,IAAI,EAE3D,CAAC,GAAW,GACZ,CAAA,EAAA,CADW,CACX,GADuB,KACvB,AAAQ,EAAC,iCAGb,IAAM,EAAO,MAAM,EAAA,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,CACtC,MAAO,CAAE,GAAI,CAAO,EACpB,OAAQ,CAAE,IAAI,EAAM,SAAU,EAAK,CACvC,EAEI,CAAC,GAAM,IAAO,EAAD,AAAM,QAAQ,EAAE,AAC7B,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,iCAGb,IAAM,EAAa,MAAM,EAAA,MAAM,CAAC,aAAa,CAAC,SAAS,CAAC,CACpD,MAAO,QACH,YACA,EACA,UAAU,EACV,KAAM,CAAE,GAAI,CAAC,QAAS,QAAQ,AAAC,CACnC,EACA,OAAQ,CAAE,MAAM,CAAK,CACzB,EAEI,CAAC,GAAY,MAAM,AACnB,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,iCAGuB,AAGhC,SAAS,CAHG,EAAW,IAAI,EAI3B,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,oBAIb,IAAM,EAAc,MAAM,EAAA,MAAM,CAAC,WAAW,CAAC,SAAS,CAAC,CACnD,MAAO,WAAE,SAAW,CAAO,EAC3B,OAAQ,CACJ,oBAAoB,EACpB,kBAAkB,EAClB,mBAAmB,EACnB,uBAAuB,EACvB,wBAAwB,EACxB,mBAAmB,EACnB,kBAAkB,EAClB,mBAAmB,EACnB,kBAAkB,EAClB,uBAAuB,EACvB,iBAAkB,GAClB,mBAAmB,CACvB,CACJ,EAEI,CAAC,GACD,CAAA,EAAA,EAAA,KADc,GACd,AAAQ,EAAC,iCAGb,IAAM,EAAO,AArFjB,SAAS,AACL,CAA8B,EAE9B,GAAI,CAAC,EAAQ,OAAO,KAEpB,IAAK,IAAM,KAAQ,EAAA,UAAU,CAAE,AAC3B,GAAK,CAAD,CAAM,OAAO,EAAE,AACd,CAAA,EAAA,EAAA,SAAS,AAAT,EAAU,EAAe,EAAK,OAAO,EAC1C,CAD6C,MACtC,EAAK,IAAI,CAGpB,OAAO,IACX,EAyEyC,EAEjC,CAAC,GACD,CAAA,EADO,AACP,EAAA,QAAA,AAAQ,EAAC,iCAGb,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,EACb,kCA7GuB"}