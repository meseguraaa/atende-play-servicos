{"version":3,"sources":["turbopack:///[project]/src/lib/prisma.ts","turbopack:///[project]/src/lib/professional-permissions.ts","turbopack:///[project]/src/components/professional/daily-exception-modal/daily-exception-modal.tsx/__nextjs-internal-proxy.mjs","turbopack:///[project]/src/components/professional/daily-exceptions-list/daily-exceptions-list.tsx/__nextjs-internal-proxy.mjs","turbopack:///[project]/src/components/professional/weekly-availability-client/weekly-availability-client.tsx/__nextjs-internal-proxy.mjs","turbopack:///[project]/src/app/professional/availability/page.tsx"],"sourcesContent":["// src/lib/prisma.ts\nimport { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = globalThis as unknown as {\n    prisma: PrismaClient | undefined;\n};\n\nexport const prisma =\n    globalForPrisma.prisma ??\n    new PrismaClient({\n        log:\n            process.env.NODE_ENV === 'development'\n                ? ['error', 'warn']\n                : ['error'],\n    });\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\n","// src/lib/professional-permissions.ts\nimport { prisma } from '@/lib/prisma';\nimport { getCurrentPainelUser } from '@/lib/painel-session';\n\nexport type ProfessionalSession = {\n    companyId: string;\n    professionalId: string;\n    userId: string;\n\n    /**\n     * ‚úÖ Opcional: unidade ‚Äúdefault‚Äù (quando existe v√≠nculo em ProfessionalUnit).\n     * N√£o √© obrigat√≥rio para n√£o quebrar fluxos j√° existentes.\n     */\n    unitId?: string;\n\n    name?: string | null;\n    email?: string;\n};\n\n/**\n * ‚úÖ Server helper (igual ao padr√£o do admin):\n * - Usa getCurrentPainelUser() (JWT/cookie do painel)\n * - Valida role PROFESSIONAL\n * - Garante v√≠nculo real do usu√°rio com Professional (companyId + userId)\n *\n * Importante:\n * - N√ÉO d√° redirect aqui (pra n√£o quebrar usos em /api).\n * - Em caso de falha, retorna strings vazias e a route decide 401.\n */\nexport async function requireProfessionalSession(): Promise<ProfessionalSession> {\n    const session = await getCurrentPainelUser();\n\n    if (!session) {\n        return { companyId: '', professionalId: '', userId: '', unitId: '' };\n    }\n\n    // precisa ser PROFESSIONAL\n    if ((session as any).role !== 'PROFESSIONAL') {\n        return { companyId: '', professionalId: '', userId: '', unitId: '' };\n    }\n\n    const userId = String((session as any).sub || '').trim();\n    const companyId = String((session as any).companyId || '').trim();\n\n    if (!userId || !companyId) {\n        return { companyId: '', professionalId: '', userId: '', unitId: '' };\n    }\n\n    // busca o professional vinculado a esse userId + companyId\n    const professional = await prisma.professional.findFirst({\n        where: {\n            userId,\n            companyId,\n            isActive: true,\n        },\n        select: {\n            id: true,\n            name: true,\n            email: true,\n        },\n    });\n\n    if (!professional?.id) {\n        return { companyId: '', professionalId: '', userId, unitId: '' };\n    }\n\n    /**\n     * ‚úÖ Unidade \"default\" (se existir v√≠nculo em ProfessionalUnit)\n     * - N√£o muda comportamento existente (s√≥ adiciona dado)\n     * - √ötil para telas que precisem filtrar por unidade sem exigir par√¢metro\n     */\n    const professionalUnit = await prisma.professionalUnit.findFirst({\n        where: {\n            companyId,\n            professionalId: professional.id,\n            isActive: true,\n        },\n        select: {\n            unitId: true,\n        },\n        orderBy: {\n            updatedAt: 'desc',\n        },\n    });\n\n    return {\n        companyId,\n        professionalId: professional.id,\n        userId,\n        unitId: professionalUnit?.unitId ?? '',\n        name: professional.name ?? null,\n        email: professional.email,\n    };\n}\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const DailyExceptionModal = registerClientReference(\n    function() { throw new Error(\"Attempted to call DailyExceptionModal() from the server but DailyExceptionModal is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/professional/daily-exception-modal/daily-exception-modal.tsx\",\n    \"DailyExceptionModal\",\n);\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const DailyExceptionsList = registerClientReference(\n    function() { throw new Error(\"Attempted to call DailyExceptionsList() from the server but DailyExceptionsList is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/professional/daily-exceptions-list/daily-exceptions-list.tsx\",\n    \"DailyExceptionsList\",\n);\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const WeeklyAvailabilityClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call WeeklyAvailabilityClient() from the server but WeeklyAvailabilityClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/professional/weekly-availability-client/weekly-availability-client.tsx\",\n    \"WeeklyAvailabilityClient\",\n);\n","// src/app/professional/availability/page.tsx\nimport type { Metadata } from 'next';\n\nimport { prisma } from '@/lib/prisma';\nimport { requireProfessionalSession } from '@/lib/professional-permissions';\n\nimport type { WeeklyAvailabilityState } from '@/components/professional/weekly-availability-form/weekly-availability-form';\n\nimport { DailyExceptionModal } from '@/components/professional/daily-exception-modal/daily-exception-modal';\nimport { DailyExceptionsList } from '@/components/professional/daily-exceptions-list/daily-exceptions-list';\nimport { WeeklyAvailabilityClient } from '@/components/professional/weekly-availability-client/weekly-availability-client';\n\nexport const dynamic = 'force-dynamic';\n\nexport const metadata: Metadata = {\n    title: 'Profissional | Disponibilidade',\n};\n\nfunction createDefaultWeeklyState(): WeeklyAvailabilityState {\n    return {\n        0: { active: false, startTime: '00:00', endTime: '23:30' }, // domingo off\n        1: { active: true, startTime: '00:00', endTime: '23:30' }, // segunda\n        2: { active: true, startTime: '00:00', endTime: '23:30' }, // ter√ßa\n        3: { active: true, startTime: '00:00', endTime: '23:30' }, // quarta\n        4: { active: true, startTime: '00:00', endTime: '23:30' }, // quinta\n        5: { active: true, startTime: '00:00', endTime: '23:30' }, // sexta\n        6: { active: true, startTime: '00:00', endTime: '23:30' }, // s√°bado\n    };\n}\n\nasync function getProfessionalScopeOrThrow() {\n    const session = await requireProfessionalSession();\n\n    const companyId = String(session.companyId || '').trim();\n    const professionalId = String(session.professionalId || '').trim();\n    const unitId = String(session.unitId || '').trim();\n\n    if (!companyId) throw new Error('missing_company');\n    if (!professionalId) throw new Error('missing_professional');\n    if (!unitId) throw new Error('missing_active_unit');\n\n    // üîí Hard lock: valida v√≠nculo e unidade ativa dentro da company\n    const active = await prisma.professionalUnit.findFirst({\n        where: {\n            companyId,\n            professionalId,\n            unitId,\n            isActive: true,\n            unit: { isActive: true },\n        },\n        select: { id: true },\n    });\n\n    if (!active) throw new Error('missing_active_unit');\n\n    return { companyId, professionalId, unitId };\n}\n\nexport default async function ProfessionalAvailabilityPage() {\n    const scope = await getProfessionalScopeOrThrow();\n\n    // Padr√£o inicial (mesmo padr√£o do form)\n    const initialState: WeeklyAvailabilityState = createDefaultWeeklyState();\n\n    // Busca o padr√£o semanal salvo (tenant/unit lock)\n    const weeklyAvailabilities =\n        await prisma.professionalWeeklyAvailability.findMany({\n            where: {\n                companyId: scope.companyId,\n                professionalId: scope.professionalId,\n                unitId: scope.unitId,\n            },\n            include: { intervals: true },\n            orderBy: { weekday: 'asc' },\n        });\n\n    // Aplica o que vier do banco por cima do default\n    for (const item of weeklyAvailabilities) {\n        const weekday = item.weekday;\n        if (typeof weekday !== 'number' || weekday < 0 || weekday > 6) continue;\n\n        const key = weekday as 0 | 1 | 2 | 3 | 4 | 5 | 6;\n\n        initialState[key].active = !!item.isActive;\n\n        const interval = item.intervals?.[0];\n        if (interval?.startTime && interval?.endTime) {\n            initialState[key].startTime = String(interval.startTime);\n            initialState[key].endTime = String(interval.endTime);\n        }\n    }\n\n    return (\n        <div className=\"space-y-6\">\n            <header className=\"flex items-center justify-between\">\n                <div className=\"space-y-1\">\n                    <h1 className=\"text-title text-content-primary\">\n                        Disponibilidade\n                    </h1>\n                    <p className=\"text-paragraph-medium-size text-content-secondary\">\n                        Defina seus hor√°rios dispon√≠veis para receber\n                        agendamentos e crie exce√ß√µes em dias espec√≠ficos.\n                    </p>\n                </div>\n            </header>\n\n            <section className=\"space-y-6\">\n                <div className=\"rounded-xl border border-border-primary bg-background-tertiary px-4 py-4 space-y-3\">\n                    <WeeklyAvailabilityClient\n                        initialValue={initialState}\n                        leftAction={\n                            <DailyExceptionModal\n                                professionalId={scope.professionalId}\n                            />\n                        }\n                    />\n                </div>\n\n                <DailyExceptionsList professionalId={scope.professionalId} />\n            </section>\n        </div>\n    );\n}\n"],"names":[],"mappings":"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","ignoreList":[2,3,4]}