{"version":3,"sources":["turbopack:///[project]/src/lib/admin-permissions.ts","turbopack:///[project]/node_modules/.pnpm/date-fns@4.1.0/node_modules/date-fns/endOfMonth.js","turbopack:///[project]/node_modules/.pnpm/date-fns@4.1.0/node_modules/date-fns/startOfMonth.js","turbopack:///[project]/src/app/admin/finance/admin-finance-client.tsx/__nextjs-internal-proxy.mjs","turbopack:///[project]/src/app/admin/finance/page.tsx"],"sourcesContent":["// src/lib/admin-permissions.ts\nimport { redirect } from 'next/navigation';\nimport { NextResponse } from 'next/server';\nimport { prisma } from '@/lib/prisma';\nimport { getCurrentPainelUser } from '@/lib/painel-session';\n\n/* =========================================================\n * Admin (Tenant)\n * ========================================================= */\n\nexport type AdminModule =\n    | 'DASHBOARD'\n    | 'REPORTS'\n    | 'CHECKOUT'\n    | 'APPOINTMENTS'\n    | 'PROFESSIONALS'\n    | 'SERVICES'\n    | 'REVIEWS'\n    | 'PRODUCTS'\n    | 'PARTNERS'\n    | 'CLIENTS'\n    | 'CLIENT_LEVELS'\n    | 'FINANCE'\n    | 'SETTINGS';\n\nexport type AdminSession = {\n    id: string;\n    name: string | null;\n    email: string;\n    role: 'ADMIN';\n    isOwner: boolean;\n    companyId: string;\n\n    // ‚úÖ Multi-unidade fica para depois\n    unitId: null;\n\n    // ‚úÖ Multi-unidade fica para depois (por enquanto sempre true pro owner e false pro resto)\n    canSeeAllUnits: boolean;\n};\n\ntype AdminAccessFlag =\n    | 'canAccessDashboard'\n    | 'canAccessReports'\n    | 'canAccessCheckout'\n    | 'canAccessAppointments'\n    | 'canAccessProfessionals'\n    | 'canAccessServices'\n    | 'canAccessReviews'\n    | 'canAccessProducts'\n    | 'canAccessPartners'\n    | 'canAccessClients'\n    | 'canAccessClientLevels'\n    | 'canAccessFinance'\n    | 'canAccessSettings';\n\ntype AdminAccessSelect = Record<AdminAccessFlag, true>;\nconst ADMIN_ACCESS_SELECT: AdminAccessSelect = {\n    canAccessDashboard: true,\n    canAccessReports: true,\n    canAccessCheckout: true,\n    canAccessAppointments: true,\n    canAccessProfessionals: true,\n    canAccessServices: true,\n    canAccessReviews: true,\n    canAccessProducts: true,\n    canAccessPartners: true,\n    canAccessClients: true,\n    canAccessClientLevels: true,\n    canAccessFinance: true,\n    canAccessSettings: true,\n};\n\nfunction moduleToAccessField(module: AdminModule): AdminAccessFlag | null {\n    switch (module) {\n        case 'DASHBOARD':\n            return 'canAccessDashboard';\n        case 'REPORTS':\n            return 'canAccessReports';\n        case 'CHECKOUT':\n            return 'canAccessCheckout';\n        case 'APPOINTMENTS':\n            return 'canAccessAppointments';\n        case 'PROFESSIONALS':\n            return 'canAccessProfessionals';\n        case 'SERVICES':\n            return 'canAccessServices';\n        case 'REVIEWS':\n            return 'canAccessReviews';\n        case 'PRODUCTS':\n            return 'canAccessProducts';\n\n        // ‚úÖ IMPORTANTE:\n        // Parceiros saiu do ADMIN (tenant) e agora pertence somente √† PLATAFORMA.\n        // Ao retornar null, o guard for√ßa redirect para o primeiro m√≥dulo permitido.\n        case 'PARTNERS':\n            return null;\n\n        case 'CLIENTS':\n            return 'canAccessClients';\n        case 'CLIENT_LEVELS':\n            return 'canAccessClientLevels';\n        case 'FINANCE':\n            return 'canAccessFinance';\n        case 'SETTINGS':\n            return 'canAccessSettings';\n        default:\n            return null;\n    }\n}\n\ntype AdminContext = {\n    id: string;\n    name: string | null;\n    email: string;\n    companyId: string;\n    isOwner: boolean;\n};\n\ntype AdminContextResult =\n    | { ok: true; ctx: AdminContext }\n    | {\n          ok: false;\n          reason:\n              | 'no_session'\n              | 'not_admin'\n              | 'invalid_token'\n              | 'user_inactive'\n              | 'no_membership'\n              | 'no_access';\n      };\n\ntype AdminContextFailureReason = Extract<\n    AdminContextResult,\n    { ok: false }\n>['reason'];\n\nasync function getAdminContext(): Promise<AdminContextResult> {\n    const session = await getCurrentPainelUser();\n\n    if (!session) return { ok: false, reason: 'no_session' };\n\n    // ‚úÖ IMPORTANTE: aqui √© TENANT ADMIN apenas\n    if (session.role !== 'ADMIN') return { ok: false, reason: 'not_admin' };\n\n    const userId = String((session as any).sub || '').trim();\n    const companyId = String((session as any).companyId || '').trim();\n\n    if (!userId || !companyId) return { ok: false, reason: 'invalid_token' };\n\n    const user = await prisma.user.findUnique({\n        where: { id: userId },\n        select: { id: true, name: true, email: true, isActive: true },\n    });\n\n    if (!user?.id || !user.isActive) {\n        return { ok: false, reason: 'user_inactive' };\n    }\n\n    const membership = await prisma.companyMember.findFirst({\n        where: {\n            userId,\n            companyId,\n            isActive: true,\n            role: { in: ['OWNER', 'ADMIN'] },\n        },\n        select: { role: true },\n    });\n\n    if (!membership?.role) return { ok: false, reason: 'no_membership' };\n\n    const isOwner = membership.role === 'OWNER';\n\n    // ‚úÖ Sub-admin precisa existir em AdminAccess (OWNER n√£o precisa)\n    if (!isOwner) {\n        const accessExists = await prisma.adminAccess.findFirst({\n            where: { userId, companyId },\n            select: { id: true },\n        });\n\n        if (!accessExists?.id) return { ok: false, reason: 'no_access' };\n    }\n\n    return {\n        ok: true,\n        ctx: {\n            id: user.id,\n            name: user.name ?? null,\n            email: user.email,\n            companyId,\n            isOwner,\n        },\n    };\n}\n\nfunction redirectToLoginByReason(reason: AdminContextFailureReason): never {\n    switch (reason) {\n        case 'no_session':\n            redirect('/painel/login?error=credenciais');\n        case 'not_admin':\n            redirect('/painel/login?error=permissao');\n        case 'invalid_token':\n        case 'user_inactive':\n        case 'no_membership':\n        case 'no_access':\n        default:\n            redirect('/painel/login?error=permissao');\n    }\n}\n\ntype ModuleRoute = { module: AdminModule; href: string };\n\n/**\n * ‚úÖ Ordem de ‚Äúmelhor destino‚Äù quando falta permiss√£o.\n *\n * Mantemos DASHBOARD por √∫ltimo (se for o √∫nico liberado, vira fallback final).\n * O restante segue a ordem do menu que voc√™ pediu.\n */\nconst FALLBACK_ROUTES: ModuleRoute[] = [\n    { module: 'APPOINTMENTS', href: '/admin/appointments' },\n    { module: 'CHECKOUT', href: '/admin/checkout' },\n    {\n        module: 'PROFESSIONALS',\n        // ‚úÖ FIX: rota correta (plural)\n        href: '/admin/professionals',\n    },\n    { module: 'SERVICES', href: '/admin/services' },\n    { module: 'PRODUCTS', href: '/admin/products' },\n\n    // ‚úÖ PARTNERS REMOVIDO do fallback (agora √© somente da PLATAFORMA)\n\n    { module: 'CLIENTS', href: '/admin/clients' },\n    { module: 'CLIENT_LEVELS', href: '/admin/client-levels' },\n    { module: 'REVIEWS', href: '/admin/review-tags' },\n    { module: 'REPORTS', href: '/admin/reports' },\n    { module: 'FINANCE', href: '/admin/finance' },\n    { module: 'SETTINGS', href: '/admin/setting' },\n    // deixa dashboard por √∫ltimo\n    { module: 'DASHBOARD', href: '/admin/dashboard' },\n];\n\nfunction pickFirstAllowedHref(\n    access: Record<string, any> | null\n): string | null {\n    if (!access) return null;\n\n    for (const r of FALLBACK_ROUTES) {\n        const flag = moduleToAccessField(r.module);\n        if (!flag) continue;\n        if (Boolean((access as any)[flag])) return r.href;\n    }\n\n    return null;\n}\n\nasync function redirectToFirstAllowedOrLogin(params: {\n    companyId: string;\n    userId: string;\n}): Promise<never> {\n    const access = await prisma.adminAccess.findFirst({\n        where: { companyId: params.companyId, userId: params.userId },\n        select: ADMIN_ACCESS_SELECT,\n    });\n\n    const href = pickFirstAllowedHref(access as any);\n    if (href) {\n        redirect(`${href}?error=permissao`);\n        throw new Error('unreachable');\n    }\n\n    redirect('/painel/login?error=permissao');\n    throw new Error('unreachable');\n}\n\n/**\n * ‚úÖ Server Components / Layouts / Pages (bloqueia com redirect)\n */\nexport async function requireAdminForModule(\n    module: AdminModule\n): Promise<AdminSession> {\n    const res = await getAdminContext();\n\n    if (!res.ok) {\n        redirectToLoginByReason(res.reason);\n    }\n\n    const ctx = res.ctx;\n\n    // OWNER: tudo liberado (mas mesmo assim, PARTNERS n√£o existe mais no Admin)\n    if (ctx.isOwner) {\n        // ‚úÖ Se tentarem acessar PARTNERS como admin-owner tenant, cai no redirect padr√£o\n        if (module === 'PARTNERS') {\n            await redirectToFirstAllowedOrLogin({\n                companyId: ctx.companyId,\n                userId: ctx.id,\n            });\n            throw new Error('unreachable');\n        }\n\n        return {\n            id: ctx.id,\n            name: ctx.name,\n            email: ctx.email,\n            role: 'ADMIN',\n            isOwner: true,\n            companyId: ctx.companyId,\n            unitId: null,\n            canSeeAllUnits: true,\n        };\n    }\n\n    const accessField = moduleToAccessField(module);\n    if (!accessField) {\n        await redirectToFirstAllowedOrLogin({\n            companyId: ctx.companyId,\n            userId: ctx.id,\n        });\n        throw new Error('unreachable');\n    }\n\n    const access = await prisma.adminAccess.findFirst({\n        where: { userId: ctx.id, companyId: ctx.companyId },\n        select: ADMIN_ACCESS_SELECT,\n    });\n\n    if (!access) {\n        await redirectToFirstAllowedOrLogin({\n            companyId: ctx.companyId,\n            userId: ctx.id,\n        });\n        throw new Error('unreachable');\n    }\n\n    const allowed = Boolean(access[accessField]);\n    if (!allowed) {\n        await redirectToFirstAllowedOrLogin({\n            companyId: ctx.companyId,\n            userId: ctx.id,\n        });\n        throw new Error('unreachable');\n    }\n\n    return {\n        id: ctx.id,\n        name: ctx.name,\n        email: ctx.email,\n        role: 'ADMIN',\n        isOwner: false,\n        companyId: ctx.companyId,\n        unitId: null,\n        canSeeAllUnits: false,\n    };\n}\n\n/**\n * ‚úÖ Route Handlers /api (bloqueia com 403 JSON)\n *\n * Uso:\n * const res = await requireAdminForModuleApi('DASHBOARD');\n * if (res instanceof NextResponse) return res;\n * const session = res;\n */\nexport async function requireAdminForModuleApi(\n    module: AdminModule\n): Promise<AdminSession | NextResponse> {\n    const res = await getAdminContext();\n\n    if (!res.ok) {\n        return NextResponse.json(\n            { ok: false, error: 'unauthorized' },\n            { status: 401 }\n        );\n    }\n\n    const ctx = res.ctx;\n\n    if (ctx.isOwner) {\n        // ‚úÖ trava PARTNERS tamb√©m na API do Admin\n        if (module === 'PARTNERS') {\n            return NextResponse.json(\n                { ok: false, error: 'forbidden' },\n                { status: 403 }\n            );\n        }\n\n        return {\n            id: ctx.id,\n            name: ctx.name,\n            email: ctx.email,\n            role: 'ADMIN',\n            isOwner: true,\n            companyId: ctx.companyId,\n            unitId: null,\n            canSeeAllUnits: true,\n        };\n    }\n\n    const accessField = moduleToAccessField(module);\n    if (!accessField) {\n        return NextResponse.json(\n            { ok: false, error: 'forbidden' },\n            { status: 403 }\n        );\n    }\n\n    const access = await prisma.adminAccess.findFirst({\n        where: { userId: ctx.id, companyId: ctx.companyId },\n        select: ADMIN_ACCESS_SELECT,\n    });\n\n    if (!access || !Boolean(access[accessField])) {\n        const fallbackHref = pickFirstAllowedHref(access as any);\n        return NextResponse.json(\n            { ok: false, error: 'forbidden', fallback: fallbackHref },\n            { status: 403 }\n        );\n    }\n\n    return {\n        id: ctx.id,\n        name: ctx.name,\n        email: ctx.email,\n        role: 'ADMIN',\n        isOwner: false,\n        companyId: ctx.companyId,\n        unitId: null,\n        canSeeAllUnits: false,\n    };\n}\n\n/* =========================================================\n * Platform (AtendePlay)\n * ========================================================= *\n * ‚úÖ MOVED OUT:\n * A plataforma agora vive em src/lib/platform-permissions.ts\n * Mantemos re-export aqui por compat (caso algum import antigo exista).\n */\n\nexport type {\n    PlatformModule,\n    PlatformSession,\n} from '@/lib/plataform-permissions';\nexport {\n    requirePlatformForModule,\n    requirePlatformForModuleApi,\n} from '@/lib/plataform-permissions';\n\n/**\n * Mantive esse export porque voc√™ j√° usou em outros pontos.\n * Implementamos de verdade quando chegar no painel do profissional.\n */\nexport async function requireProfessionalSession(): Promise<never> {\n    throw new Error(\n        'requireProfessionalSession ainda n√£o foi implementado (n√£o √© necess√°rio neste passo).'\n    );\n}\n","import { toDate } from \"./toDate.js\";\n\n/**\n * The {@link endOfMonth} function options.\n */\n\n/**\n * @name endOfMonth\n * @category Month Helpers\n * @summary Return the end of a month for the given date.\n *\n * @description\n * Return the end of a month for the given date.\n * The result will be in the local timezone.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments. Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed, or inferred from the arguments.\n *\n * @param date - The original date\n * @param options - An object with options\n *\n * @returns The end of a month\n *\n * @example\n * // The end of a month for 2 September 2014 11:55:00:\n * const result = endOfMonth(new Date(2014, 8, 2, 11, 55, 0))\n * //=> Tue Sep 30 2014 23:59:59.999\n */\nexport function endOfMonth(date, options) {\n  const _date = toDate(date, options?.in);\n  const month = _date.getMonth();\n  _date.setFullYear(_date.getFullYear(), month + 1, 0);\n  _date.setHours(23, 59, 59, 999);\n  return _date;\n}\n\n// Fallback for modularized imports:\nexport default endOfMonth;\n","import { toDate } from \"./toDate.js\";\n\n/**\n * The {@link startOfMonth} function options.\n */\n\n/**\n * @name startOfMonth\n * @category Month Helpers\n * @summary Return the start of a month for the given date.\n *\n * @description\n * Return the start of a month for the given date. The result will be in the local timezone.\n *\n * @typeParam DateType - The `Date` type, the function operates on. Gets inferred from passed arguments.\n * Allows to use extensions like [`UTCDate`](https://github.com/date-fns/utc).\n * @typeParam ResultDate - The result `Date` type, it is the type returned from the context function if it is passed,\n * or inferred from the arguments.\n *\n * @param date - The original date\n * @param options - An object with options\n *\n * @returns The start of a month\n *\n * @example\n * // The start of a month for 2 September 2014 11:55:00:\n * const result = startOfMonth(new Date(2014, 8, 2, 11, 55, 0))\n * //=> Mon Sep 01 2014 00:00:00\n */\nexport function startOfMonth(date, options) {\n  const _date = toDate(date, options?.in);\n  _date.setDate(1);\n  _date.setHours(0, 0, 0, 0);\n  return _date;\n}\n\n// Fallback for modularized imports:\nexport default startOfMonth;\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/app/admin/finance/admin-finance-client.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/admin/finance/admin-finance-client.tsx\",\n    \"default\",\n);\n","// src/app/admin/finance/page.tsx\nimport type { Metadata } from 'next';\nimport { redirect } from 'next/navigation';\n\nimport { prisma } from '@/lib/prisma';\nimport { requireAdminForModule } from '@/lib/admin-permissions';\nimport AdminFinanceClient, {\n    type AdminFinanceSummaryUI,\n    type ProfessionalMonthlyEarningsUI,\n    type ExpenseRowUI,\n} from './admin-finance-client';\n\nimport {\n    addMonths,\n    endOfMonth,\n    format,\n    isValid,\n    parse,\n    startOfMonth,\n} from 'date-fns';\nimport { ptBR } from 'date-fns/locale';\n\nexport const dynamic = 'force-dynamic';\n\nexport const metadata: Metadata = {\n    title: 'Admin | Financeiro',\n};\n\ntype AdminFinancePageProps = {\n    searchParams: Promise<{\n        month?: string; // yyyy-MM\n        unit?: string; // unitId (mantemos compat com \"all\", mas redireciona)\n    }>;\n};\n\nfunction parseMonthParam(month?: string): Date {\n    if (!month) return startOfMonth(new Date());\n    const parsed = parse(month, 'yyyy-MM', new Date());\n    if (!isValid(parsed)) return startOfMonth(new Date());\n    return startOfMonth(parsed);\n}\n\nfunction capitalizeFirst(v: string) {\n    if (!v) return v;\n    return v.charAt(0).toUpperCase() + v.slice(1);\n}\n\nfunction buildFinanceRedirect(params: { month?: string; unit?: string }) {\n    const sp = new URLSearchParams();\n\n    if (params.month) sp.set('month', params.month);\n    if (params.unit) sp.set('unit', params.unit);\n\n    const qs = sp.toString();\n    return qs ? `/admin/finance?${qs}` : '/admin/finance';\n}\n\nfunction clampDayToMonth(day: number, monthDate: Date): number {\n    const last = endOfMonth(monthDate).getDate();\n    if (day <= 1) return 1;\n    if (day >= last) return last;\n    return day;\n}\n\n/**\n * ‚úÖ Auto-cria√ß√£o de despesas recorrentes ao entrar no m√™s:\n * - Busca recorrentes do m√™s anterior (mesma unidade)\n * - Cria no m√™s atual o que estiver faltando\n */\nasync function ensureRecurringExpensesForMonth(args: {\n    companyId: string;\n    unitId: string;\n    monthDate: Date; // startOfMonth\n}) {\n    const { companyId, unitId, monthDate } = args;\n\n    const monthStart = startOfMonth(monthDate);\n    const monthEnd = endOfMonth(monthDate);\n\n    const prevMonth = startOfMonth(addMonths(monthDate, -1));\n    const prevStart = startOfMonth(prevMonth);\n    const prevEnd = endOfMonth(prevMonth);\n\n    // 1) Recorrentes do m√™s anterior (fonte)\n    const prevRecurring = await prisma.expense.findMany({\n        where: {\n            companyId,\n            unitId,\n            isRecurring: true,\n            dueDate: { gte: prevStart, lte: prevEnd },\n        },\n        select: {\n            id: true,\n            description: true,\n            category: true,\n            amount: true,\n            dueDate: true,\n        },\n        orderBy: [{ dueDate: 'asc' }, { createdAt: 'asc' }],\n    });\n\n    if (prevRecurring.length === 0) return;\n\n    // 2) Recorrentes j√° existentes no m√™s atual (para dedupe)\n    const currentRecurring = await prisma.expense.findMany({\n        where: {\n            companyId,\n            unitId,\n            isRecurring: true,\n            dueDate: { gte: monthStart, lte: monthEnd },\n        },\n        select: {\n            description: true,\n            category: true,\n            amount: true,\n            dueDate: true,\n        },\n    });\n\n    const existingKey = new Set(\n        currentRecurring.map((e) => {\n            const day = e.dueDate.getDate();\n            return [\n                companyId,\n                unitId,\n                'REC',\n                e.category,\n                e.description.trim().toLowerCase(),\n                Number(e.amount).toFixed(2),\n                String(day),\n            ].join('|');\n        })\n    );\n\n    const toCreate = prevRecurring\n        .map((src) => {\n            const day = src.dueDate.getDate();\n            const clampedDay = clampDayToMonth(day, monthDate);\n            const dueDate = new Date(\n                monthDate.getFullYear(),\n                monthDate.getMonth(),\n                clampedDay\n            );\n\n            const key = [\n                companyId,\n                unitId,\n                'REC',\n                src.category,\n                src.description.trim().toLowerCase(),\n                Number(src.amount).toFixed(2),\n                String(clampedDay),\n            ].join('|');\n\n            return {\n                key,\n                data: {\n                    companyId,\n                    unitId,\n                    description: src.description,\n                    category: src.category,\n                    amount: Number(src.amount).toFixed(2), // Decimal string ok\n                    dueDate,\n                    isRecurring: true,\n                    isPaid: false, // novo m√™s come√ßa em aberto\n                },\n            };\n        })\n        .filter((x) => !existingKey.has(x.key));\n\n    if (toCreate.length === 0) return;\n\n    await prisma.expense.createMany({\n        data: toCreate.map((x) => x.data),\n        skipDuplicates: false,\n    });\n}\n\n/* -------------------------------------------------------\n * Helpers: c√°lculo de ganhos e faturamento do m√™s\n * ------------------------------------------------------*/\n\nfunction safeNumber(v: unknown): number {\n    const n = Number(v);\n    return Number.isFinite(n) ? n : 0;\n}\n\nfunction computeServiceProfessionalEarning(args: {\n    professionalEarningValue: unknown;\n    servicePriceAtTheTime: unknown;\n    professionalPercentageAtTheTime: unknown;\n}): number {\n    const direct = safeNumber(args.professionalEarningValue);\n    if (direct > 0) return direct;\n\n    const price = safeNumber(args.servicePriceAtTheTime);\n    const pct = safeNumber(args.professionalPercentageAtTheTime);\n\n    if (price > 0 && pct > 0) return (price * pct) / 100;\n\n    return 0;\n}\n\nexport default async function AdminFinancePage({\n    searchParams,\n}: AdminFinancePageProps) {\n    const session = await requireAdminForModule('FINANCE');\n\n    // üîí Hard lock multi-tenant\n    const companyId = session.companyId;\n    if (!companyId) {\n        redirect('/admin');\n    }\n\n    // ‚úÖ FIX: AdminSession usa `id` (n√£o `userId`)\n    const userId = session.id;\n    if (!userId) {\n        redirect('/admin');\n    }\n\n    const canSeeAllUnits = !!(session as any)?.canSeeAllUnits;\n\n    const { month: monthParam, unit: unitParam } = await searchParams;\n\n    const referenceDate = parseMonthParam(monthParam);\n    const monthStart = startOfMonth(referenceDate);\n    const monthEnd = endOfMonth(referenceDate);\n\n    const monthQuery = format(referenceDate, 'yyyy-MM');\n    const monthLabel = capitalizeFirst(\n        format(referenceDate, \"MMMM 'de' yyyy\", { locale: ptBR })\n    );\n\n    const units = canSeeAllUnits\n        ? await prisma.unit.findMany({\n              where: { companyId, isActive: true },\n              select: { id: true, name: true },\n              orderBy: { name: 'asc' },\n          })\n        : await (async () => {\n              const access = await prisma.adminUnitAccess.findMany({\n                  where: { companyId, userId },\n                  select: { unitId: true },\n              });\n\n              const unitIds = access.map((a) => a.unitId).filter(Boolean);\n\n              if (!unitIds.length) return [];\n\n              return prisma.unit.findMany({\n                  where: {\n                      companyId,\n                      isActive: true,\n                      id: { in: unitIds },\n                  },\n                  select: { id: true, name: true },\n                  orderBy: { name: 'asc' },\n              });\n          })();\n\n    const defaultUnitId = units.length > 0 ? units[0].id : null;\n\n    // ‚úÖ Se n√£o tiver nenhuma unidade acess√≠vel, mant√©m a p√°gina mas tudo desabilitado\n    if (!defaultUnitId) {\n        const summary: AdminFinanceSummaryUI = {\n            netRevenueMonth: 'R$ 0,00',\n            servicesNetMonth: 'R$ 0,00',\n            productsNetMonth: 'R$ 0,00',\n            totalExpenses: 'R$ 0,00',\n            netIncome: 'R$ 0,00',\n            netIncomeIsPositive: true,\n        };\n\n        return (\n            <AdminFinanceClient\n                scopeLabel={'Nenhuma unidade dispon√≠vel'}\n                monthLabel={monthLabel}\n                monthQuery={monthQuery}\n                summary={summary}\n                professionalEarnings={[]}\n                expenses={[]}\n                newExpenseDisabled={true}\n            />\n        );\n    }\n\n    // ‚úÖ Regra: sempre ter um unit real na URL (compat: se vier unit=all, cai na default)\n    if (!unitParam || unitParam === 'all') {\n        redirect(\n            buildFinanceRedirect({ month: monthQuery, unit: defaultUnitId })\n        );\n    }\n\n    // ‚úÖ Unidade ativa (filtro)\n    const activeUnitId: string = unitParam;\n\n    // valida na lista acess√≠vel (units) + valida no banco (multi-tenant)\n    const inAllowedList = units.some((u) => u.id === activeUnitId);\n\n    if (!inAllowedList) {\n        redirect(\n            buildFinanceRedirect({ month: monthQuery, unit: defaultUnitId })\n        );\n    }\n\n    const ok = await prisma.unit.findFirst({\n        where: { id: activeUnitId, companyId, isActive: true },\n        select: { id: true },\n    });\n\n    if (!ok) {\n        redirect(\n            buildFinanceRedirect({ month: monthQuery, unit: defaultUnitId })\n        );\n    }\n\n    // ‚úÖ AUTO: ao entrar no m√™s, cria recorrentes faltantes\n    await ensureRecurringExpensesForMonth({\n        companyId,\n        unitId: activeUnitId,\n        monthDate: monthStart,\n    });\n\n    const scopeLabel = (() => {\n        const found = units.find((u) => u.id === activeUnitId);\n        return found?.name ?? 'unidade selecionada';\n    })();\n\n    const newExpenseDisabled = !activeUnitId;\n\n    const currencyFormatter = new Intl.NumberFormat('pt-BR', {\n        style: 'currency',\n        currency: 'BRL',\n    });\n\n    /* -------------------------------------------------------\n     * DESPESAS\n     * ------------------------------------------------------*/\n    const expensesDb = await prisma.expense.findMany({\n        where: {\n            companyId,\n            unitId: activeUnitId,\n            dueDate: { gte: monthStart, lte: monthEnd },\n        } as any,\n        orderBy: [{ dueDate: 'asc' }, { createdAt: 'asc' }],\n        select: {\n            id: true,\n            description: true,\n            dueDate: true,\n            amount: true,\n            isRecurring: true,\n            isPaid: true,\n        },\n    });\n\n    const expenses: ExpenseRowUI[] = expensesDb.map((e) => ({\n        id: e.id,\n        description: e.description,\n        dueDate: format(e.dueDate, 'dd/MM/yyyy', { locale: ptBR }),\n        amount: currencyFormatter.format(Number(e.amount)),\n        isRecurring: !!e.isRecurring,\n        statusLabel: e.isPaid ? 'Pago' : 'Em aberto',\n        statusTone: e.isPaid ? 'success' : 'warning',\n    }));\n\n    const totalExpensesNumber = expensesDb.reduce(\n        (sum, e) => sum + Number(e.amount),\n        0\n    );\n\n    /* -------------------------------------------------------\n     * FATURAMENTO (pagos no m√™s)\n     * Servi√ßos: Appointment.checkedOutAt dentro do m√™s\n     * Produtos: Order COMPLETED atualizado dentro do m√™s (proxy de \"pago\")\n     * ------------------------------------------------------*/\n\n    // 1) Profissionais ativos da unidade (para o bloco de cards)\n    const professionalUnits = await prisma.professionalUnit.findMany({\n        where: {\n            companyId,\n            unitId: activeUnitId,\n            isActive: true,\n            professional: { isActive: true },\n        },\n        select: {\n            professional: { select: { id: true, name: true } },\n        },\n        orderBy: { createdAt: 'asc' },\n    });\n\n    const professionalsBase = professionalUnits\n        .map((x) => x.professional)\n        .filter(Boolean);\n\n    const professionalsById = new Map<string, { id: string; name: string }>();\n    for (const p of professionalsBase) {\n        if (!p?.id) continue;\n        professionalsById.set(p.id, { id: p.id, name: p.name });\n    }\n\n    // 2) Servi√ßos pagos no m√™s (Checkout)\n    const paidAppointments = await prisma.appointment.findMany({\n        where: {\n            companyId,\n            unitId: activeUnitId,\n            checkedOutAt: { gte: monthStart, lte: monthEnd },\n            // evita cancelados\n            status: { not: 'CANCELED' },\n        },\n        select: {\n            professionalId: true,\n            servicePriceAtTheTime: true,\n            professionalPercentageAtTheTime: true,\n            professionalEarningValue: true,\n        },\n    });\n\n    const servicesNetMonthNumber = paidAppointments.reduce((sum, a) => {\n        return sum + safeNumber(a.servicePriceAtTheTime);\n    }, 0);\n\n    // Ganho por profissional (servi√ßos)\n    const servicesEarningsByProfessional = new Map<string, number>();\n    for (const a of paidAppointments) {\n        const pid = String(a.professionalId ?? '').trim();\n        if (!pid) continue;\n\n        const earn = computeServiceProfessionalEarning({\n            professionalEarningValue: a.professionalEarningValue,\n            servicePriceAtTheTime: a.servicePriceAtTheTime,\n            professionalPercentageAtTheTime: a.professionalPercentageAtTheTime,\n        });\n\n        servicesEarningsByProfessional.set(\n            pid,\n            (servicesEarningsByProfessional.get(pid) ?? 0) + earn\n        );\n    }\n\n    // 3) Produtos pagos no m√™s\n    //    Regra: pedidos COMPLETED cujo updatedAt est√° dentro do m√™s\n    //    (n√£o temos completedAt no schema, ent√£o updatedAt √© o proxy mais pragm√°tico)\n    const completedOrders = await prisma.order.findMany({\n        where: {\n            companyId,\n            unitId: activeUnitId,\n            status: 'COMPLETED',\n            updatedAt: { gte: monthStart, lte: monthEnd },\n        },\n        select: { id: true },\n    });\n\n    const orderIds = completedOrders.map((o) => o.id);\n\n    let productsNetMonthNumber = 0;\n    const productsEarningsByProfessional = new Map<string, number>();\n\n    if (orderIds.length > 0) {\n        const productItems = await prisma.orderItem.findMany({\n            where: {\n                companyId,\n                orderId: { in: orderIds },\n                productId: { not: null },\n            },\n            select: {\n                professionalId: true,\n                totalPrice: true,\n                product: { select: { professionalPercentage: true } },\n            },\n        });\n\n        // Net de produtos (valor total de itens de produto)\n        productsNetMonthNumber = productItems.reduce((sum, it) => {\n            return sum + safeNumber(it.totalPrice);\n        }, 0);\n\n        // Comiss√£o por profissional: totalPrice * product.professionalPercentage/100\n        for (const it of productItems) {\n            const pid = String(it.professionalId ?? '').trim();\n            if (!pid) continue;\n\n            const total = safeNumber(it.totalPrice);\n            const pct = safeNumber(it.product?.professionalPercentage);\n\n            const commission = total > 0 && pct > 0 ? (total * pct) / 100 : 0;\n\n            productsEarningsByProfessional.set(\n                pid,\n                (productsEarningsByProfessional.get(pid) ?? 0) + commission\n            );\n        }\n    }\n\n    // 4) Monta lista UI (inclui profissionais da unidade, mesmo com 0)\n    const allProfessionalIds = new Set<string>([\n        ...Array.from(professionalsById.keys()),\n        ...Array.from(servicesEarningsByProfessional.keys()),\n        ...Array.from(productsEarningsByProfessional.keys()),\n    ]);\n\n    const professionalEarnings: ProfessionalMonthlyEarningsUI[] = Array.from(\n        allProfessionalIds\n    )\n        .map((pid) => {\n            const base = professionalsById.get(pid);\n\n            const services = servicesEarningsByProfessional.get(pid) ?? 0;\n            const products = productsEarningsByProfessional.get(pid) ?? 0;\n            const total = services + products;\n\n            return {\n                professionalId: pid,\n                name: base?.name ?? 'Profissional',\n                servicesEarnings: currencyFormatter.format(services),\n                productsEarnings: currencyFormatter.format(products),\n                total: currencyFormatter.format(total),\n            };\n        })\n        // ordem: maior total primeiro\n        .sort((a, b) => {\n            const na = safeNumber(\n                a.total\n                    .replace(/[^\\d,.-]/g, '')\n                    .replace('.', '')\n                    .replace(',', '.')\n            );\n            const nb = safeNumber(\n                b.total\n                    .replace(/[^\\d,.-]/g, '')\n                    .replace('.', '')\n                    .replace(',', '.')\n            );\n            return nb - na;\n        });\n\n    const netRevenueMonthNumber =\n        servicesNetMonthNumber + productsNetMonthNumber;\n\n    const netIncomeNumber = netRevenueMonthNumber - totalExpensesNumber;\n\n    const summary: AdminFinanceSummaryUI = {\n        netRevenueMonth: currencyFormatter.format(netRevenueMonthNumber),\n        servicesNetMonth: currencyFormatter.format(servicesNetMonthNumber),\n        productsNetMonth: currencyFormatter.format(productsNetMonthNumber),\n        totalExpenses: currencyFormatter.format(totalExpensesNumber),\n        netIncome: currencyFormatter.format(netIncomeNumber),\n        netIncomeIsPositive: netIncomeNumber >= 0,\n    };\n\n    return (\n        <AdminFinanceClient\n            scopeLabel={scopeLabel}\n            monthLabel={monthLabel}\n            monthQuery={monthQuery}\n            summary={summary}\n            professionalEarnings={professionalEarnings}\n            expenses={expenses}\n            newExpenseDisabled={newExpenseDisabled}\n        />\n    );\n}\n"],"names":[],"mappings":"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","ignoreList":[1,2,3]}